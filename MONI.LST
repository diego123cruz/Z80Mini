0001   0000             ; ---------------------------------------------------------
0002   0000             ;   Z80 Mini  -  inicio 01/2022
0003   0000             ;   Diego Cruz - github.com/diego123cruz
0004   0000             ;
0005   0000             ;   Hardware baseado em: http://www.sunrise-ev.com/z80.htm
0006   0000             ;   Software próprio - em construção
0007   0000             ; ---------------------------------------------------------
0008   0000             ;   Z80@4Mhz
0009   0000             ;   ROM 32k - 28C256
0010   0000             ;   RAM 32k - 65256
0011   0000             ;   Display 7 segmentos 8 digitos
0012   0000             ;   Teclado 16 teclas + Fn (Tecla de função? ou outra coisa?)
0013   0000             ;   Entrada 40h
0014   0000             ;   Saida 40h
0015   0000             ;
0016   0000             ;
0017   0000             ; ---------------------------------------------------------
0018   0000             ;   Display 7 Segmentos - In(Port40) AND 00000111b
0019   0000             ; ---------------------------------------------------------
0020   0000             ;
0021   0000             ;   ------------------------------------------------
0022   0000             ;   | 00h | 01h | 02h | 03h | 04h | 05h | 06h | 07h |
0023   0000             ;   ------------------------------------------------
0024   0000             ;
0025   0000             ;               A(0)
0026   0000             ;            ---------
0027   0000             ;           |         |
0028   0000             ;      F(5) |         | B(1)
0029   0000             ;           |   G(6)  |
0030   0000             ;            ---------
0031   0000             ;           |         |
0032   0000             ;      E(4) |         | C(2)
0033   0000             ;           |         |
0034   0000             ;            ---------         Ponto(7)
0035   0000             ;               D(3) 
0036   0000             ;
0037   0000             ;
0038   0000             ;
0039   0000             ;
0040   0000             ;
0041   0000             ; ---------------------------------------------------------
0042   0000             ; Teclado 
0043   0000             ; ---------------------------------------------------------
0044   0000             ;   
0045   0000             ;   Keys:        
0046   0000             ;       Fn - In(Port40) AND 00010000b - pulldown
0047   0000             ;       0 - In(Port40) AND 00000111b
0048   0000             ;
0049   0000             ;
0050   0000             ;
0051   0000             ;
0052   0000             
0053   0000             
0054   0000             ; ---------------------------------------------------------
0055   0000             ; Constantes
0056   0000             ; ---------------------------------------------------------
0057   0000             
0058   0000             Port40        .equ    $40
0059   0000             PortC0        .equ    $C0
0060   0000             START_RAM     .equ    $8000
0061   0000             STACK         .equ    $FF00  
0062   0000             CKEY_TIMEOUT  .equ    100  ; 100ms +-
0063   0000             
0064   0000             ; ---------------------------------------------------------
0065   0000             ; RAM MAP - Monitor | $FF00 - $FFFF
0066   0000             ; ---------------------------------------------------------
0067   0000             ; Cada digito fica em um ponto da memoria RAM
0068   0000             DIG_0       .equ    $FF00   ;(1) endereço do digito 0 na memoria RAM
0069   0000             DIG_1       .equ    $FF01   ;(1) endereço do digito 1 na memoria RAM
0070   0000             DIG_2       .equ    $FF02   ;(1) endereço do digito 2 na memoria RAM
0071   0000             DIG_3       .equ    $FF03   ;(1) endereço do digito 3 na memoria RAM
0072   0000             DIG_4       .equ    $FF04   ;(1) endereço do digito 4 na memoria RAM
0073   0000             DIG_5       .equ    $FF05   ;(1) endereço do digito 5 na memoria RAM
0074   0000             DIG_6       .equ    $FF06   ;(1) endereço do digito 6 na memoria RAM
0075   0000             DIG_7       .equ    $FF07   ;(1) endereço do digito 7 na memoria RAM
0076   0000             KEY_PRESS   .equ    $FF08   ;(1) key atual
0077   0000             INPUT       .equ    $FF09   ;(1) temp input from int
0078   0000             TMP_KEY     .equ    $FF0A   ;(1) tmp key
0079   0000             KEY_TIMEOUT .equ    $FF0B   ;(1) tempo para retornar a tecla, CKEY_TIMEOUT
0080   0000             SHOW_DIG    .equ    $FF0C   ;(1) LIVRE
0081   0000             PC_RAM      .equ    $FF0D   ;(2) save pc to user start $8000
0082   0000             
0083   0000             SYSMODE     .equ    $FF0F   ;(1) System mode. 
0084   0000                                         ; 0 - User Mode
0085   0000                                         ; 1 - Monitor
0086   0000                                         ; 2 - Examine Memoria
0087   0000                                         ; 3 - Change Data(Memory)
0088   0000                                         ; 4 - Show register PC
0089   0000                                         ; 5 - Show register SP
0090   0000                                         ; 6 - Show register AF
0091   0000                                         ; 7 - Show register BC
0092   0000                                         ; 8 - Show register DE
0093   0000                                         ; 9 - Show register HL
0094   0000                                         ; A - Show register IX
0095   0000                                         ; B - Show register IY
0096   0000             TicCounter  .equ    $FF10   ;(2) TicCounter inc 1ms
0097   0000             EXM_COUNT   .equ    $FF12   ;(1) Count digits Examine function, 4 digits
0098   0000             MDF_COUNT   .equ    $FF13   ;(1) Count digits moDify function, 2 digits
0099   0000             USR_PC      .equ    $FF14   ;(2) PC 
0100   0000             USR_SP      .equ    $FF16   ;(2) SP
0101   0000             USR_HL      .equ    $FF18   ;(2) HL
0102   0000             USR_BC      .equ    $FF1A   ;(2) BC
0103   0000             USR_DE      .equ    $FF1C   ;(2) DE
0104   0000             USR_AF      .equ    $FF1E   ;(2) AF
0105   0000             USR_IX      .equ    $FF20   ;(2) IX
0106   0000             USR_IY      .equ    $FF22   ;(2) IY
0107   0000             USR_AFA     .equ    $FF24   ;(2) AF' (Aux)
0108   0000             USR_BCA     .equ    $FF26   ;(2) BC' (Aux)
0109   0000             USR_DEA     .equ    $FF28   ;(2) DE' (Aux)
0110   0000             USR_HLA     .equ    $FF2A   ;(2) HL' (Aux)
0111   0000             ; SP Temp   .equ    $FF2C
0112   0000             
0113   0000             
0114   0000             
0115   0000             ; Copy USER_DISPx to DIG_x WHEN USER_MODE
0116   0000             USER_DISP0  .equ    $FFD0   ; Mode User - Display Dig 0  - 01234567
0117   0000             USER_DISP1  .equ    $FFD1   ; Mode User - Display Dig 1  - 01234567
0118   0000             USER_DISP2  .equ    $FFD2   ; Mode User - Display Dig 2  - 01234567
0119   0000             USER_DISP3  .equ    $FFD3   ; Mode User - Display Dig 3  - 01234567
0120   0000             USER_DISP4  .equ    $FFD4   ; Mode User - Display Dig 4  - 01234567
0121   0000             USER_DISP5  .equ    $FFD5   ; Mode User - Display Dig 5  - 01234567
0122   0000             USER_DISP6  .equ    $FFD6   ; Mode User - Display Dig 6  - 01234567
0123   0000             USER_DISP7  .equ    $FFD7   ; Mode User - Display Dig 7  - 01234567
0124   0000             
0125   0000             
0126   0000             
0127   0000             ; =========================================================
0128   0000             ; Start ROM
0129   0000             ; =========================================================
0130   0000             .org    $0000
0131   0000 C3 35 06        JP  START
0132   0003             
0133   0003             ; =========================================================
0134   0003             ; Livre para colocar funções 0003h - 0037h 
0135   0003             ; =========================================================
0136   0003             
0137   0003             ; delay_100ms
0138   0003             
0139   0003             ; char7segFromA
0140   0003             
0141   0003             ; animacaoLeds
0142   0003             
0143   0003             ; Limpar RAM (FF).... etc
0144   0003             
0145   0003             
0146   0003             ; =========================================================
0147   0003             ; Int 38h
0148   0003             ; =========================================================
0149   0038             .org    $38
0150   0038 F3              DI                       ; Disable interrupt
0151   0039             
0152   0039 ED 73 16 FF     LD (USR_SP), SP          ; Save SP
0153   003D 22 18 FF        LD (USR_HL), HL          ; Save HL
0154   0040 E1              POP  HL                  ; Recupera PC da stack
0155   0041 22 14 FF        LD (USR_PC), HL          ; Save PC
0156   0044 E5              PUSH HL                  ;
0157   0045 21 2C FF        LD HL, $FF2C             ; Carrega Temp SP to HL
0158   0048 F9              LD SP, HL                ; Set temp HL
0159   0049 D9              EXX                      ; Inverte HL e HL', DE.... BC....
0160   004A E5              PUSH  HL                 ; Save HL'
0161   004B D5              PUSH  DE                 ; Save DE'                
0162   004C C5              PUSH  BC                 ; Save BC'
0163   004D F5              PUSH  AF                 ; Save AF'
0164   004E D9              EXX                      ; Troca HL' e HL,, DE... BC...
0165   004F FD E5           PUSH  IY                 ; Save IY
0166   0051 DD E5           PUSH  IX                 ; Save IX
0167   0053 F5              PUSH  AF                 ; Save AF
0168   0054 D5              PUSH  DE                 ; Save DE
0169   0055 C5              PUSH  BC                 ; Save BC
0170   0056 2A 16 FF        LD HL, (USR_SP)          ; Recupera SP
0171   0059 F9              LD SP, HL                ; Devolve SP original
0172   005A             
0173   005A                 ; TicCounter
0174   005A 2A 10 FF        LD  HL, (TicCounter)     ; Increment 1ms, used to DELAY_A
0175   005D 23              INC  HL
0176   005E 22 10 FF        LD  (TicCounter), HL
0177   0061             
0178   0061                 ; Timeout Key
0179   0061 3A 0B FF         LD A, (KEY_TIMEOUT)
0180   0064 FE 00            CP 0
0181   0066 CA 6D 00         JP Z, ENTER_MAIN
0182   0069 3D               DEC A
0183   006A 32 0B FF         LD (KEY_TIMEOUT), A
0184   006D             
0185   006D                 ; Main
0186   006D             ENTER_MAIN:
0187   006D CD 93 00        CALL UPDATE_DISPLAYS
0188   0070 CD AF 00        CALL UPDATE_KEYS
0189   0073             
0190   0073                 ; Show atual digit
0191   0073 3A 0C FF        LD  A, (SHOW_DIG)
0192   0076 D3 40           OUT (Port40), A
0193   0078             
0194   0078                 ;CALL    TRATAMENTO_INT38H; Get key, update display   
0195   0078 C3 FE 00        JP      SYS_MAIN         ; Execute function monitor
0196   007B             
0197   007B             EXIT_SYS:
0198   007B E1              POP HL                   ; Troca o PC
0199   007C 2A 14 FF        LD HL, (USR_PC)          ; Recupera PC
0200   007F E5              PUSH HL                  ; Devolve PC to stack
0201   0080             
0202   0080 2A 1E FF        LD HL, (USR_AF)          ; Load AF in HL
0203   0083 E5              PUSH  HL                 ; Push AF
0204   0084 F1              POP AF                   ; Recovery AF
0205   0085 2A 18 FF        LD HL, (USR_HL)          ; Recovery HL
0206   0088 ED 5B 1C FF     LD DE, (USR_DE)          ; Recovery DE
0207   008C ED 4B 1A FF     LD BC, (USR_BC)          ; Recovery BC
0208   0090             
0209   0090 FB              EI                       ; Enable interrupt
0210   0091 ED 4D           RETI                     ; Return interrupt
0211   0093             
0212   0093             
0213   0093             ; =========================================================
0214   0093             ; Update display - Tratamento Int 38h
0215   0093             ; =========================================================
0216   0093             UPDATE_DISPLAYS:    
0217   0093 DB 40           IN    A, (Port40)
0218   0095 32 09 FF        LD    (INPUT), A
0219   0098 E6 07           AND   $07
0220   009A FE 08           CP    $08
0221   009C D2 AE 00        JP    NC, UPDATE_DISPLAYS_RET ; IF A > 7 RET
0222   009F 3C              INC   A
0223   00A0 FE 08           CP    $08
0224   00A2 C2 A7 00        JP    NZ, UPDATE_DISPLAYS_OK
0225   00A5 3E 00           LD    A, $00
0226   00A7             UPDATE_DISPLAYS_OK:
0227   00A7 26 FF           LD    H, $FF
0228   00A9 6F              LD    L, A
0229   00AA 7E              LD    A, (HL)
0230   00AB 32 0C FF        LD   (SHOW_DIG), A
0231   00AE             UPDATE_DISPLAYS_RET:
0232   00AE C9              RET
0233   00AF             
0234   00AF             ; =========================================================
0235   00AF             ; Update KEY - Tratamento Int 38h
0236   00AF             ; =========================================================
0237   00AF             UPDATE_KEYS:    
0238   00AF DB 40           IN    A, (Port40)
0239   00B1 32 09 FF        LD    (INPUT), A
0240   00B4 E6 07           AND   $07
0241   00B6 FE 08           CP    $08
0242   00B8 D2 E1 00        JP    NC, UPDATE_KEY_RET ; IF A > 7 RET
0243   00BB 3A 09 FF        LD  A,  (INPUT)
0244   00BE CB 5F           BIT  3, A
0245   00C0 CA E2 00        JP  Z, TRATAB3
0246   00C3 3A 09 FF        LD  A,  (INPUT)
0247   00C6 CB 67           BIT  4, A
0248   00C8 CA E8 00        JP  Z, TRATAB4
0249   00CB C3 E1 00        JP  UPDATE_KEY_RET
0250   00CE             UPDATE_KEY_GET:
0251   00CE 32 09 FF        LD    (INPUT), A
0252   00D1 E6 07           AND   $07
0253   00D3 01 00 00        LD    BC, 0
0254   00D6 4F              LD    C, A
0255   00D7 09              ADD   HL, BC
0256   00D8 7E              LD    A, (HL)
0257   00D9 32 08 FF        LD   (KEY_PRESS), A
0258   00DC 3E 64           LD A, CKEY_TIMEOUT
0259   00DE 32 0B FF        LD (KEY_TIMEOUT), A
0260   00E1             UPDATE_KEY_RET:
0261   00E1 C9              RET
0262   00E2             
0263   00E2             TRATAB3:
0264   00E2 21 EE 00        LD    HL, KEYSB3
0265   00E5 C3 CE 00        JP  UPDATE_KEY_GET
0266   00E8             
0267   00E8             TRATAB4:
0268   00E8 21 F6 00        LD    HL, KEYSB4
0269   00EB C3 CE 00        JP  UPDATE_KEY_GET
0270   00EE             
0271   00EE 000104070F02KEYSB3 .db $00, $01, $04, $07, $0F, $02, $05, $08
0271   00F4 0508
0272   00F6 0E0306090D0CKEYSB4 .db $0E, $03, $06, $09, $0D, $0C, $0B, $0A
0272   00FC 0B0A
0273   00FE             
0274   00FE             
0275   00FE             
0276   00FE             ; =========================================================
0277   00FE             ; SYS MAIN
0278   00FE             ; =========================================================
0279   00FE             SYS_MAIN:
0280   00FE 3A 0F FF        LD  A, (SYSMODE)
0281   0101 FE 00           CP  $00                  ; User mode can back to monitor
0282   0103 CA 7C 03        JP  Z, USER_MODE        
0283   0106             
0284   0106 3A 0F FF        LD  A, (SYSMODE)
0285   0109 FE 01           CP  $01                  ; monitor
0286   010B CA 92 03        JP  Z, MONITOR_MODE
0287   010E             
0288   010E 3A 0F FF        LD  A,  (SYSMODE)
0289   0111 FE 02           CP  $02                  ; Examine RAM
0290   0113 CA 61 01        JP  Z, EXAMINE_RAM
0291   0116             
0292   0116 3A 0F FF        LD  A, (SYSMODE)
0293   0119 FE 03           CP  $03                  ; Modify Data (Memory)
0294   011B CA FA 01        JP  Z,  MODIFY_RAM
0295   011E             
0296   011E 3A 0F FF        LD  A, (SYSMODE)
0297   0121 FE 04           CP  $04                  ; Show register PC
0298   0123 CA 49 02        JP  Z,  SHOW_REG_PC
0299   0126             
0300   0126 3A 0F FF        LD  A, (SYSMODE)
0301   0129 FE 05           CP  $05                  ; Show register SP
0302   012B CA 6C 02        JP  Z,  SHOW_REG_SP
0303   012E             
0304   012E 3A 0F FF        LD  A, (SYSMODE)
0305   0131 FE 06           CP  $06                  ; Show register AF
0306   0133 CA 8F 02        JP  Z,  SHOW_REG_AF
0307   0136             
0308   0136 3A 0F FF        LD  A, (SYSMODE)
0309   0139 FE 07           CP  $07                  ; Show register BC
0310   013B CA B2 02        JP  Z,  SHOW_REG_BC
0311   013E             
0312   013E 3A 0F FF        LD  A, (SYSMODE)
0313   0141 FE 08           CP  $08                  ; Show register DE
0314   0143 CA D5 02        JP  Z,  SHOW_REG_DE
0315   0146             
0316   0146 3A 0F FF        LD  A, (SYSMODE)
0317   0149 FE 09           CP  $09                  ; Show register HL
0318   014B CA F8 02        JP  Z,  SHOW_REG_HL
0319   014E             
0320   014E 3A 0F FF        LD  A, (SYSMODE)
0321   0151 FE 0A           CP  $0A                  ; Show register IX
0322   0153 CA 1B 03        JP  Z,  SHOW_REG_IX
0323   0156             
0324   0156 3A 0F FF        LD  A, (SYSMODE)
0325   0159 FE 0B           CP  $0B                  ; Show register IY
0326   015B CA 3E 03        JP  Z,  SHOW_REG_IY
0327   015E             
0328   015E             
0329   015E C3 7B 00        JP  EXIT_SYS
0330   0161             
0331   0161             
0332   0161             ; =========================================================
0333   0161             ; Examine RAM Mode
0334   0161             ; =========================================================
0335   0161             EXAMINE_RAM:
0336   0161 CD 61 03        CALL GET_KEY_A
0337   0164 FE FF           CP  $FF
0338   0166 CA 7B 00        JP  Z, EXIT_SYS
0339   0169             
0340   0169 F5              PUSH  AF
0341   016A F5              PUSH  AF
0342   016B 3A 12 FF        LD  A, (EXM_COUNT)
0343   016E FE 03           CP  3
0344   0170 CA 8E 01        JP  Z, EXAMINE_KEY_POS_3
0345   0173             
0346   0173 3A 12 FF        LD  A, (EXM_COUNT)
0347   0176 FE 02           CP  2
0348   0178 CA AC 01        JP  Z, EXAMINE_KEY_POS_2
0349   017B             
0350   017B 3A 12 FF        LD  A, (EXM_COUNT)
0351   017E FE 01           CP  1
0352   0180 CA C6 01        JP  Z, EXAMINE_KEY_POS_1
0353   0183             
0354   0183 3A 12 FF        LD  A, (EXM_COUNT)
0355   0186 FE 00           CP  0
0356   0188 CA E7 01        JP  Z, EXAMINE_KEY_POS_0
0357   018B             
0358   018B C3 7B 00        JP  EXIT_SYS
0359   018E             
0360   018E             EXAMINE_KEY_POS_3:
0361   018E F1              POP  AF
0362   018F CB 07           RLC  A
0363   0191 CB 07           RLC  A
0364   0193 CB 07           RLC  A
0365   0195 CB 07           RLC  A
0366   0197 67              LD  H, A
0367   0198 22 0D FF        LD  (PC_RAM), HL
0368   019B F1              POP  AF
0369   019C CD 26 05        CALL GET_NUM_FROM_LOW
0370   019F 32 00 FF        LD  (DIG_0), A
0371   01A2 3A 12 FF        LD  A, (EXM_COUNT)
0372   01A5 3D              DEC A
0373   01A6 32 12 FF        LD  (EXM_COUNT), A
0374   01A9 C3 7B 00        JP  EXIT_SYS
0375   01AC             
0376   01AC             
0377   01AC             EXAMINE_KEY_POS_2:
0378   01AC F1              POP  AF
0379   01AD 2A 0D FF        LD  HL, (PC_RAM)
0380   01B0 B4              OR  H
0381   01B1 67              LD  H, A
0382   01B2 22 0D FF        LD  (PC_RAM), HL
0383   01B5 F1              POP  AF
0384   01B6 CD 26 05        CALL GET_NUM_FROM_LOW
0385   01B9 32 01 FF        LD  (DIG_1), A
0386   01BC 3A 12 FF        LD  A, (EXM_COUNT)
0387   01BF 3D              DEC A
0388   01C0 32 12 FF        LD  (EXM_COUNT), A
0389   01C3 C3 7B 00        JP  EXIT_SYS
0390   01C6             
0391   01C6             EXAMINE_KEY_POS_1:
0392   01C6 F1              POP  AF
0393   01C7 2A 0D FF        LD  HL, (PC_RAM)
0394   01CA CB 07           RLC  A
0395   01CC CB 07           RLC  A
0396   01CE CB 07           RLC  A
0397   01D0 CB 07           RLC  A
0398   01D2 6F              LD  L, A
0399   01D3 22 0D FF        LD  (PC_RAM), HL
0400   01D6 F1              POP  AF
0401   01D7 CD 26 05        CALL GET_NUM_FROM_LOW
0402   01DA 32 02 FF        LD  (DIG_2), A
0403   01DD 3A 12 FF        LD  A, (EXM_COUNT)
0404   01E0 3D              DEC A
0405   01E1 32 12 FF        LD  (EXM_COUNT), A
0406   01E4 C3 7B 00        JP  EXIT_SYS
0407   01E7             
0408   01E7             
0409   01E7             EXAMINE_KEY_POS_0:
0410   01E7 F1              POP  AF
0411   01E8 2A 0D FF        LD  HL, (PC_RAM)
0412   01EB B5              OR  L
0413   01EC 6F              LD  L, A
0414   01ED 22 0D FF        LD  (PC_RAM), HL
0415   01F0 F1              POP  AF
0416   01F1 CD 26 05        CALL GET_NUM_FROM_LOW
0417   01F4 32 03 FF        LD  (DIG_3), A
0418   01F7 C3 73 04        JP  GO_MONITOR
0419   01FA             
0420   01FA             ; =========================================================
0421   01FA             ; MODIFY RAM Mode
0422   01FA             ; =========================================================
0423   01FA             MODIFY_RAM:
0424   01FA             
0425   01FA CD 61 03        CALL GET_KEY_A
0426   01FD FE FF           CP  $FF
0427   01FF CA 7B 00        JP  Z, EXIT_SYS
0428   0202             
0429   0202 F5              PUSH  AF
0430   0203 F5              PUSH  AF
0431   0204 3A 13 FF        LD  A, (MDF_COUNT)
0432   0207 FE 01           CP  1
0433   0209 CA 17 02        JP  Z, MODIFY_KEY_POS_1
0434   020C             
0435   020C 3A 13 FF        LD  A, (MDF_COUNT)
0436   020F FE 00           CP  0
0437   0211 CA 35 02        JP  Z, MODIFY_KEY_POS_0
0438   0214             
0439   0214 C3 7B 00        JP  EXIT_SYS
0440   0217             
0441   0217             MODIFY_KEY_POS_1:
0442   0217 F1              POP  AF
0443   0218 CB 07           RLC  A
0444   021A CB 07           RLC  A
0445   021C CB 07           RLC  A
0446   021E CB 07           RLC  A
0447   0220 2A 0D FF        LD  HL, (PC_RAM)
0448   0223 77              LD  (HL), A
0449   0224             
0450   0224 F1              POP  AF
0451   0225 CD 26 05        CALL GET_NUM_FROM_LOW
0452   0228 32 06 FF        LD  (DIG_6), A
0453   022B 3A 13 FF        LD  A, (MDF_COUNT)
0454   022E 3D              DEC A
0455   022F 32 13 FF        LD  (MDF_COUNT), A
0456   0232 C3 7B 00        JP  EXIT_SYS
0457   0235             
0458   0235             MODIFY_KEY_POS_0:
0459   0235 F1              POP  AF
0460   0236 2A 0D FF        LD  HL, (PC_RAM)
0461   0239 46              LD  B, (HL)
0462   023A B0              OR  B
0463   023B 2A 0D FF        LD  HL, (PC_RAM)
0464   023E 77              LD  (HL), A
0465   023F             
0466   023F F1              POP  AF
0467   0240 CD 26 05        CALL GET_NUM_FROM_LOW
0468   0243 32 07 FF        LD  (DIG_7), A
0469   0246 C3 73 04        JP  GO_MONITOR
0470   0249                 
0471   0249             
0472   0249               
0473   0249             
0474   0249             SHOW_REG_PC:
0475   0249 CD 61 03        CALL  GET_KEY_A
0476   024C FE 00           CP  0
0477   024E CA 73 04        JP Z, GO_MONITOR
0478   0251 CD EC 04        CALL  CLEAR_DISPLAY
0479   0254             
0480   0254 3E 50           LD  A, $50               ; R
0481   0256 32 00 FF        LD  (DIG_0), A
0482   0259             
0483   0259 3E 73           LD  A, $73               ; P
0484   025B 32 01 FF        LD  (DIG_1), A
0485   025E             
0486   025E 3E 39           LD  A, $39
0487   0260 32 02 FF        LD  (DIG_2), A           ; C
0488   0263             
0489   0263 2A 14 FF        LD HL, (USR_PC)
0490   0266 CD D8 05        CALL PRINT_END_HL
0491   0269 C3 7B 00        JP  EXIT_SYS
0492   026C             
0493   026C             
0494   026C             SHOW_REG_SP:
0495   026C CD 61 03        CALL  GET_KEY_A
0496   026F FE 00           CP  0
0497   0271 CA 73 04        JP Z, GO_MONITOR
0498   0274             
0499   0274 CD EC 04        CALL  CLEAR_DISPLAY
0500   0277             
0501   0277 3E 50           LD  A, $50               ; R
0502   0279 32 00 FF        LD  (DIG_0), A
0503   027C             
0504   027C 3E 6D           LD  A, $6D               ; S
0505   027E 32 01 FF        LD  (DIG_1), A
0506   0281             
0507   0281 3E 73           LD  A, $73               ; P
0508   0283 32 02 FF        LD  (DIG_2), A
0509   0286             
0510   0286 2A 16 FF        LD HL, (USR_SP)
0511   0289 CD D8 05        CALL PRINT_END_HL
0512   028C C3 7B 00        JP  EXIT_SYS
0513   028F             
0514   028F             
0515   028F             SHOW_REG_AF:
0516   028F CD 61 03        CALL  GET_KEY_A
0517   0292 FE 00           CP  0
0518   0294 CA 73 04        JP Z, GO_MONITOR
0519   0297 CD EC 04        CALL  CLEAR_DISPLAY
0520   029A             
0521   029A 3E 50           LD  A, $50               ; R
0522   029C 32 00 FF        LD  (DIG_0), A
0523   029F             
0524   029F 3E 77           LD  A, $77               ; A
0525   02A1 32 01 FF        LD  (DIG_1), A
0526   02A4             
0527   02A4 3E 71           LD  A, $71               ; F
0528   02A6 32 02 FF        LD  (DIG_2), A
0529   02A9             
0530   02A9 2A 1E FF        LD HL, (USR_AF)
0531   02AC CD D8 05        CALL PRINT_END_HL
0532   02AF C3 7B 00        JP  EXIT_SYS
0533   02B2             
0534   02B2             
0535   02B2             SHOW_REG_BC:
0536   02B2 CD 61 03        CALL  GET_KEY_A
0537   02B5 FE 00           CP  0
0538   02B7 CA 73 04        JP Z, GO_MONITOR
0539   02BA CD EC 04        CALL  CLEAR_DISPLAY
0540   02BD             
0541   02BD 3E 50           LD  A, $50               ; R
0542   02BF 32 00 FF        LD  (DIG_0), A
0543   02C2             
0544   02C2 3E 7C           LD  A, $7C               ; B
0545   02C4 32 01 FF        LD  (DIG_1), A
0546   02C7             
0547   02C7 3E 39           LD  A, $39               ; C
0548   02C9 32 02 FF        LD  (DIG_2), A
0549   02CC             
0550   02CC 2A 1A FF        LD HL, (USR_BC)
0551   02CF CD D8 05        CALL PRINT_END_HL
0552   02D2 C3 7B 00        JP  EXIT_SYS
0553   02D5             
0554   02D5             SHOW_REG_DE:
0555   02D5 CD 61 03        CALL  GET_KEY_A
0556   02D8 FE 00           CP  0
0557   02DA CA 73 04        JP Z, GO_MONITOR
0558   02DD CD EC 04        CALL  CLEAR_DISPLAY
0559   02E0             
0560   02E0 3E 50           LD  A, $50               ; R
0561   02E2 32 00 FF        LD  (DIG_0), A
0562   02E5             
0563   02E5 3E 5E           LD  A, $5E               ; D
0564   02E7 32 01 FF        LD  (DIG_1), A
0565   02EA             
0566   02EA 3E 79           LD  A, $79               ; E
0567   02EC 32 02 FF        LD  (DIG_2), A
0568   02EF             
0569   02EF 2A 1C FF        LD HL, (USR_DE)
0570   02F2 CD D8 05        CALL PRINT_END_HL
0571   02F5 C3 7B 00        JP  EXIT_SYS
0572   02F8             
0573   02F8             SHOW_REG_HL:
0574   02F8 CD 61 03        CALL  GET_KEY_A
0575   02FB FE 00           CP  0
0576   02FD CA 73 04        JP Z, GO_MONITOR
0577   0300 CD EC 04        CALL  CLEAR_DISPLAY
0578   0303             
0579   0303 3E 50           LD  A, $50               ; R
0580   0305 32 00 FF        LD  (DIG_0), A
0581   0308             
0582   0308 3E 76           LD  A, $76               ; H
0583   030A 32 01 FF        LD  (DIG_1), A
0584   030D             
0585   030D 3E 38           LD  A, $38               ; L
0586   030F 32 02 FF        LD  (DIG_2), A
0587   0312             
0588   0312 2A 18 FF        LD HL, (USR_HL)
0589   0315 CD D8 05        CALL PRINT_END_HL
0590   0318 C3 7B 00        JP  EXIT_SYS
0591   031B             
0592   031B             SHOW_REG_IX:
0593   031B CD 61 03        CALL  GET_KEY_A
0594   031E FE 00           CP  0
0595   0320 CA 73 04        JP Z, GO_MONITOR
0596   0323 CD EC 04        CALL  CLEAR_DISPLAY
0597   0326             
0598   0326 3E 50           LD  A, $50               ; R
0599   0328 32 00 FF        LD  (DIG_0), A
0600   032B             
0601   032B 3E 06           LD  A, $06               ; I
0602   032D 32 01 FF        LD  (DIG_1), A
0603   0330             
0604   0330 3E 70           LD  A, $70               ; X
0605   0332 32 02 FF        LD  (DIG_2), A
0606   0335             
0607   0335 2A 20 FF        LD HL, (USR_IX)
0608   0338 CD D8 05        CALL PRINT_END_HL
0609   033B C3 7B 00        JP  EXIT_SYS
0610   033E             
0611   033E             SHOW_REG_IY:
0612   033E CD 61 03        CALL  GET_KEY_A
0613   0341 FE 00           CP  0
0614   0343 CA 73 04        JP Z, GO_MONITOR
0615   0346 CD EC 04        CALL  CLEAR_DISPLAY
0616   0349             
0617   0349 3E 50           LD  A, $50               ; R
0618   034B 32 00 FF        LD  (DIG_0), A
0619   034E             
0620   034E 3E 06           LD  A, $06               ; I
0621   0350 32 01 FF        LD  (DIG_1), A
0622   0353             
0623   0353 3E 6E           LD  A, $6E               ; Y
0624   0355 32 02 FF        LD  (DIG_2), A
0625   0358             
0626   0358 2A 22 FF        LD HL, (USR_IY)
0627   035B CD D8 05        CALL PRINT_END_HL
0628   035E C3 7B 00        JP  EXIT_SYS
0629   0361             
0630   0361             ; =========================================================
0631   0361             ; GET KEY IN A, IF A == FFh then no KEY
0632   0361             ; =========================================================
0633   0361             GET_KEY_A:
0634   0361 3A 0B FF        LD  A, (KEY_TIMEOUT)
0635   0364 FE 00           CP  0
0636   0366 CA 6C 03        JP  Z, RET_KEY
0637   0369 3E FF           LD  A, $FF
0638   036B C9              RET
0639   036C             
0640   036C             RET_KEY:
0641   036C 3E 64           LD A, CKEY_TIMEOUT
0642   036E 32 0B FF        LD (KEY_TIMEOUT), A
0643   0371             
0644   0371 3A 08 FF        LD  A, (KEY_PRESS)
0645   0374 F5              PUSH  AF
0646   0375 3E FF           LD  A, $FF
0647   0377 32 08 FF        LD  (KEY_PRESS), A
0648   037A F1              POP  AF
0649   037B C9              RET
0650   037C             
0651   037C             
0652   037C             ; =========================================================
0653   037C             ; MONITOR Mode
0654   037C             ; =========================================================
0655   037C             USER_MODE:
0656   037C 3A 09 FF        LD  A, (INPUT)
0657   037F FE FB           CP  $FB
0658   0381 CA 73 04        JP  Z, GO_MONITOR
0659   0384                 
0660   0384                 ; Copy USER_DISPx to DIG_x
0661   0384 21 D0 FF        LD	HL, USER_DISP0
0662   0387 11 00 FF    	LD	DE, DIG_0
0663   038A 01 08 00    	LD	BC, $0008
0664   038D ED B0       	LDIR
0665   038F             
0666   038F C3 7B 00        JP  EXIT_SYS
0667   0392             
0668   0392             MONITOR_MODE:
0669   0392                 ; Mostra o endereço
0670   0392 2A 0D FF        LD  HL, (PC_RAM)
0671   0395 CD 7B 05        CALL PRINT_HL
0672   0398             
0673   0398                 ; Limpa digitos
0674   0398 3E 00           LD  A, 0
0675   039A 32 04 FF        LD  (DIG_4), A
0676   039D 32 05 FF        LD  (DIG_5), A
0677   03A0             
0678   03A0                 ; Mostra os dados no endereço
0679   03A0 2A 0D FF        LD  HL, (PC_RAM)
0680   03A3 7E              LD  A, (HL)
0681   03A4 CD 4E 05        CALL  PRINT_A
0682   03A7             
0683   03A7             
0684   03A7 CD 61 03        CALL  GET_KEY_A
0685   03AA             
0686   03AA                 ; Incrementa endereço
0687   03AA 32 0A FF        LD (TMP_KEY), A
0688   03AD FE 0A           CP  $0A
0689   03AF CA 2F 04        JP  Z,  PC_RAM_INC
0690   03B2             
0691   03B2                 ; Decrementa endereço
0692   03B2 3A 0A FF        LD  A, (TMP_KEY)
0693   03B5 FE 0B           CP  $0B
0694   03B7 CA 25 04        JP  Z,  PC_RAM_DEC
0695   03BA             
0696   03BA                 ; Examina memoria
0697   03BA 3A 0A FF        LD  A, (TMP_KEY)
0698   03BD FE 0E           CP  $0E
0699   03BF CA 39 04        JP  Z,  GO_EXAMINE
0700   03C2             
0701   03C2                 ; + moDify Memory
0702   03C2 3A 0A FF        LD  A, (TMP_KEY)
0703   03C5 FE 0C           CP  $0C
0704   03C7 CA 54 04        JP  Z,  GO_ADD_MODIFY
0705   03CA             
0706   03CA                 ; moDify Memory
0707   03CA 3A 0A FF        LD  A, (TMP_KEY)
0708   03CD FE 0D           CP  $0D
0709   03CF CA 5E 04        JP  Z,  GO_MODIFY
0710   03D2             
0711   03D2                 ; RUN
0712   03D2 3A 0A FF        LD  A, (TMP_KEY)
0713   03D5 FE 0F           CP  $0F
0714   03D7 CA D6 04        JP  Z,  FIRE
0715   03DA             
0716   03DA                 ; Show register PC
0717   03DA 3A 0A FF        LD  A, (TMP_KEY)
0718   03DD FE 01           CP  $01
0719   03DF CA 7E 04        JP  Z, GO_SHOW_REG_PC
0720   03E2             
0721   03E2                 ; Show register SP
0722   03E2 3A 0A FF        LD  A, (TMP_KEY)
0723   03E5 FE 02           CP  $02
0724   03E7 CA 89 04        JP  Z, GO_SHOW_REG_SP
0725   03EA             
0726   03EA                 ; Show register AF
0727   03EA 3A 0A FF        LD  A, (TMP_KEY)
0728   03ED FE 03           CP  $03
0729   03EF CA 94 04        JP  Z, GO_SHOW_REG_AF
0730   03F2             
0731   03F2                 ; Show register BC
0732   03F2 3A 0A FF        LD  A, (TMP_KEY)
0733   03F5 FE 04           CP  $04
0734   03F7 CA 9F 04        JP  Z, GO_SHOW_REG_BC
0735   03FA             
0736   03FA                 ; Show register DE
0737   03FA 3A 0A FF        LD  A, (TMP_KEY)
0738   03FD FE 05           CP  $05
0739   03FF CA AA 04        JP  Z, GO_SHOW_REG_DE
0740   0402             
0741   0402                 ; Show register HL
0742   0402 3A 0A FF        LD  A, (TMP_KEY)
0743   0405 FE 06           CP  $06
0744   0407 CA B5 04        JP  Z, GO_SHOW_REG_HL
0745   040A             
0746   040A                 ; Show register IX
0747   040A 3A 0A FF        LD  A, (TMP_KEY)
0748   040D FE 07           CP  $07
0749   040F CA C0 04        JP  Z, GO_SHOW_REG_IX
0750   0412             
0751   0412                 ; Show register iY
0752   0412 3A 0A FF        LD  A, (TMP_KEY)
0753   0415 FE 08           CP  $08
0754   0417 CA CB 04        JP  Z, GO_SHOW_REG_IY
0755   041A             
0756   041A                 ; Back to user mode
0757   041A 3A 0A FF        LD  A, (TMP_KEY)
0758   041D FE 09           CP  $09
0759   041F CA E4 04        JP  Z, GO_USER_MODE
0760   0422             
0761   0422 C3 7B 00        JP  EXIT_SYS
0762   0425                 
0763   0425             
0764   0425             PC_RAM_DEC:
0765   0425 2A 0D FF        LD  HL, (PC_RAM)
0766   0428 2B              DEC  HL
0767   0429 22 0D FF        LD  (PC_RAM), HL
0768   042C C3 7B 00        JP  EXIT_SYS
0769   042F             
0770   042F             PC_RAM_INC:
0771   042F 2A 0D FF        LD  HL, (PC_RAM)
0772   0432 23              INC  HL
0773   0433 22 0D FF        LD  (PC_RAM), HL
0774   0436 C3 7B 00        JP  EXIT_SYS
0775   0439             
0776   0439             GO_EXAMINE:
0777   0439 3E 03           LD  A, $03
0778   043B 32 12 FF        LD (EXM_COUNT), A        ; Set count 4 digits, position display
0779   043E 3E 02           LD  A, $02
0780   0440 32 0F FF        LD (SYSMODE), A          ; Examine mode
0781   0443 3E 40           LD A, 01000000b
0782   0445 32 00 FF        LD (DIG_0), A
0783   0448 32 01 FF        LD (DIG_1), A
0784   044B 32 02 FF        LD (DIG_2), A
0785   044E 32 03 FF        LD (DIG_3), A
0786   0451 C3 7B 00        JP  EXIT_SYS
0787   0454             
0788   0454             GO_ADD_MODIFY:
0789   0454 2A 0D FF        LD  HL, (PC_RAM)
0790   0457 23              INC HL
0791   0458 22 0D FF        LD  (PC_RAM), HL
0792   045B CD 7B 05        CALL  PRINT_HL
0793   045E             GO_MODIFY:
0794   045E 3E 01           LD  A, $01                  ; Set count 2 digits, position display
0795   0460 32 13 FF        LD  (MDF_COUNT), A
0796   0463 3E 03           LD  A, $03                  ; moDify mode (Memory)
0797   0465 32 0F FF        LD  (SYSMODE), A
0798   0468 3E 40           LD  A, 01000000b
0799   046A 32 06 FF        LD  (DIG_6), A
0800   046D 32 07 FF        LD  (DIG_7), A
0801   0470 C3 7B 00        JP  EXIT_SYS
0802   0473             
0803   0473             GO_MONITOR:
0804   0473 CD EC 04        CALL  CLEAR_DISPLAY
0805   0476 3E 01           LD  A, $01
0806   0478 32 0F FF        LD  (SYSMODE), A
0807   047B C3 7B 00        JP  EXIT_SYS
0808   047E             
0809   047E             GO_SHOW_REG_PC:
0810   047E CD EC 04        CALL CLEAR_DISPLAY
0811   0481 3E 04           LD  A, $04
0812   0483 32 0F FF        LD  (SYSMODE), A
0813   0486 C3 7B 00        JP  EXIT_SYS
0814   0489             
0815   0489             GO_SHOW_REG_SP:
0816   0489 CD EC 04        CALL CLEAR_DISPLAY
0817   048C 3E 05           LD  A, $05
0818   048E 32 0F FF        LD  (SYSMODE), A
0819   0491 C3 7B 00        JP  EXIT_SYS
0820   0494             
0821   0494             GO_SHOW_REG_AF:
0822   0494 CD EC 04        CALL CLEAR_DISPLAY
0823   0497 3E 06           LD  A, $06
0824   0499 32 0F FF        LD  (SYSMODE), A
0825   049C C3 7B 00        JP  EXIT_SYS
0826   049F             
0827   049F             GO_SHOW_REG_BC:
0828   049F CD EC 04        CALL CLEAR_DISPLAY
0829   04A2 3E 07           LD  A, $07
0830   04A4 32 0F FF        LD  (SYSMODE), A
0831   04A7 C3 7B 00        JP  EXIT_SYS
0832   04AA             
0833   04AA             GO_SHOW_REG_DE:
0834   04AA CD EC 04        CALL CLEAR_DISPLAY
0835   04AD 3E 08           LD  A, $08
0836   04AF 32 0F FF        LD  (SYSMODE), A
0837   04B2 C3 7B 00        JP  EXIT_SYS
0838   04B5             
0839   04B5             GO_SHOW_REG_HL:
0840   04B5 CD EC 04        CALL CLEAR_DISPLAY
0841   04B8 3E 09           LD  A, $09
0842   04BA 32 0F FF        LD  (SYSMODE), A
0843   04BD C3 7B 00        JP  EXIT_SYS
0844   04C0             
0845   04C0             GO_SHOW_REG_IX:
0846   04C0 CD EC 04        CALL CLEAR_DISPLAY
0847   04C3 3E 0A           LD  A, $0A
0848   04C5 32 0F FF        LD  (SYSMODE), A
0849   04C8 C3 7B 00        JP  EXIT_SYS
0850   04CB             
0851   04CB             GO_SHOW_REG_IY:
0852   04CB CD EC 04        CALL CLEAR_DISPLAY
0853   04CE 3E 0B           LD  A, $0B
0854   04D0 32 0F FF        LD  (SYSMODE), A
0855   04D3 C3 7B 00        JP  EXIT_SYS
0856   04D6             
0857   04D6             FIRE:
0858   04D6 3E 01           LD  A, 1
0859   04D8 32 0F FF        LD (SYSMODE), A          ; Monitor mode
0860   04DB 2A 0D FF        LD  HL, (PC_RAM)
0861   04DE 22 14 FF        LD  (USR_PC), HL
0862   04E1 C3 7B 00        JP  EXIT_SYS
0863   04E4             
0864   04E4             GO_USER_MODE:
0865   04E4 3E 00           LD  A, 0
0866   04E6 32 0F FF        LD  (SYSMODE), A
0867   04E9 C3 7B 00        JP  EXIT_SYS
0868   04EC             
0869   04EC             ; =========================================================
0870   04EC             ; LIMPA DISPLAY
0871   04EC             ; =========================================================
0872   04EC             CLEAR_DISPLAY:
0873   04EC F5              PUSH  AF
0874   04ED 3E 00           LD  A, 0
0875   04EF 32 00 FF        LD  (DIG_0), A
0876   04F2 32 01 FF        LD  (DIG_1), A
0877   04F5 32 02 FF        LD  (DIG_2), A
0878   04F8 32 03 FF        LD  (DIG_3), A
0879   04FB 32 04 FF        LD  (DIG_4), A
0880   04FE 32 05 FF        LD  (DIG_5), A
0881   0501 32 06 FF        LD  (DIG_6), A
0882   0504 32 07 FF        LD  (DIG_7), A
0883   0507 F1              POP  AF
0884   0508 C9              RET
0885   0509             
0886   0509             ; =========================================================
0887   0509             ; LIMPA USER DISPLAY
0888   0509             ; =========================================================
0889   0509             CLEAR_USER_DISPLAY:
0890   0509 F5              PUSH  AF
0891   050A 3E 00           LD  A, 0
0892   050C 32 D0 FF        LD  (USER_DISP0), A
0893   050F 32 D1 FF        LD  (USER_DISP1), A
0894   0512 32 D2 FF        LD  (USER_DISP2), A
0895   0515 32 D3 FF        LD  (USER_DISP3), A
0896   0518 32 D4 FF        LD  (USER_DISP4), A
0897   051B 32 D5 FF        LD  (USER_DISP5), A
0898   051E 32 D6 FF        LD  (USER_DISP6), A
0899   0521 32 D7 FF        LD  (USER_DISP7), A
0900   0524 F1              POP  AF
0901   0525 C9              RET
0902   0526             
0903   0526             
0904   0526             ; =========================================================
0905   0526             ; PEGA LOW NUM EM A E RETORNA CHAR 7SEG EM A
0906   0526             ; =========================================================
0907   0526             GET_NUM_FROM_LOW:
0908   0526 E5              PUSH    HL
0909   0527 C5              PUSH    BC
0910   0528 21 A8 06        LD      HL, LED_FONT
0911   052B E6 0F           AND     $0F
0912   052D 01 00 00        LD      BC, 0
0913   0530 4F              LD      C, A
0914   0531 09              ADD     HL, BC
0915   0532 7E              LD      A, (HL)
0916   0533 C1              POP     BC
0917   0534 E1              POP     HL
0918   0535 C9              RET
0919   0536             
0920   0536             ; =========================================================
0921   0536             ; PEGA HIGH NUM EM A E RETORNA CHAR 7SEG EM A
0922   0536             ; =========================================================
0923   0536             GET_NUM_FROM_HIGH:
0924   0536 E5              PUSH    HL
0925   0537 C5              PUSH    BC
0926   0538 21 A8 06        LD      HL, LED_FONT
0927   053B E6 F0           AND     $F0
0928   053D CB 0F           RRC     A
0929   053F CB 0F           RRC     A
0930   0541 CB 0F           RRC     A
0931   0543 CB 0F           RRC     A
0932   0545 01 00 00        LD      BC, 0
0933   0548 4F              LD      C, A
0934   0549 09              ADD     HL, BC
0935   054A 7E              LD      A, (HL)
0936   054B C1              POP     BC
0937   054C E1              POP     HL
0938   054D C9              RET
0939   054E             
0940   054E             ; =========================================================
0941   054E             ; Mostra o que esta em A nos digitos 6 e 7
0942   054E             ; =========================================================
0943   054E             PRINT_A:
0944   054E E5              PUSH    HL
0945   054F C5              PUSH    BC
0946   0550 F5              PUSH    AF
0947   0551 F5              PUSH    AF
0948   0552             
0949   0552 21 A8 06        LD	HL, LED_FONT
0950   0555 E6 0F           AND $0F
0951   0557 01 00 00        LD      BC, 0
0952   055A 4F              LD      C, A
0953   055B 09              ADD HL, BC
0954   055C 7E              LD  A, (HL)
0955   055D 32 07 FF        LD  (DIG_7), A
0956   0560             
0957   0560 F1              POP    AF
0958   0561 21 A8 06        LD	HL, LED_FONT
0959   0564 E6 F0           AND  $F0
0960   0566 CB 0F           RRC  A
0961   0568 CB 0F           RRC  A
0962   056A CB 0F           RRC  A
0963   056C CB 0F           RRC  A
0964   056E 01 00 00        LD      BC, 0
0965   0571 4F              LD      C, A
0966   0572 09              ADD HL, BC
0967   0573 7E              LD  A, (HL)
0968   0574 32 06 FF        LD  (DIG_6), A
0969   0577             
0970   0577 F1              POP     AF
0971   0578 C1              POP     BC
0972   0579 E1              POP     HL
0973   057A C9              RET
0974   057B             
0975   057B             ; =========================================================
0976   057B             ; Mostra o que esta em HL - Display(HHLLXXXX)
0977   057B             ; =========================================================
0978   057B             PRINT_HL:
0979   057B F5              PUSH  AF
0980   057C E5              PUSH  HL
0981   057D C5              PUSH  BC
0982   057E             
0983   057E E5              PUSH  HL
0984   057F E5              PUSH  HL
0985   0580 E5              PUSH  HL
0986   0581             
0987   0581 7D              LD  A, L
0988   0582 21 A8 06        LD	HL, LED_FONT
0989   0585 E6 0F           AND $0F
0990   0587 01 00 00        LD      BC, 0
0991   058A 4F              LD      C, A
0992   058B 09              ADD HL, BC
0993   058C 7E              LD  A, (HL)
0994   058D 21 03 FF        LD  HL, DIG_3
0995   0590 77              LD  (HL), A
0996   0591             
0997   0591 E1              POP  HL
0998   0592 7D              LD  A, L
0999   0593 21 A8 06        LD	HL, LED_FONT
1000   0596 E6 F0           AND  $F0
1001   0598 CB 0F           RRC  A
1002   059A CB 0F           RRC  A
1003   059C CB 0F           RRC  A
1004   059E CB 0F           RRC  A
1005   05A0 01 00 00        LD      BC, 0
1006   05A3 4F              LD      C, A
1007   05A4 09              ADD HL, BC
1008   05A5 7E              LD  A, (HL)
1009   05A6 21 02 FF        LD  HL, DIG_2
1010   05A9 77              LD  (HL), A
1011   05AA             
1012   05AA E1              POP  HL
1013   05AB 7C              LD  A, H
1014   05AC 21 A8 06        LD	HL, LED_FONT
1015   05AF E6 0F           AND $0F
1016   05B1 01 00 00        LD      BC, 0
1017   05B4 4F              LD      C, A
1018   05B5 09              ADD HL, BC
1019   05B6 7E              LD  A, (HL)
1020   05B7 21 01 FF        LD  HL, DIG_1
1021   05BA 77              LD  (HL), A
1022   05BB             
1023   05BB E1              POP  HL
1024   05BC 7C              LD  A, H
1025   05BD 21 A8 06        LD	HL, LED_FONT
1026   05C0 E6 F0           AND  $F0
1027   05C2 CB 0F           RRC  A
1028   05C4 CB 0F           RRC  A
1029   05C6 CB 0F           RRC  A
1030   05C8 CB 0F           RRC  A
1031   05CA 01 00 00        LD      BC, 0
1032   05CD 4F              LD      C, A
1033   05CE 09              ADD HL, BC
1034   05CF 7E              LD  A, (HL)
1035   05D0 21 00 FF        LD  HL, DIG_0
1036   05D3 77              LD  (HL), A
1037   05D4             
1038   05D4 C1              POP  BC
1039   05D5 E1              POP  HL
1040   05D6 F1              POP  AF
1041   05D7             
1042   05D7 C9              RET
1043   05D8             
1044   05D8             ; =========================================================
1045   05D8             ; Mostra o que esta em HL - Display(XXXXHHLL)
1046   05D8             ; =========================================================
1047   05D8             PRINT_END_HL:
1048   05D8 F5              PUSH  AF
1049   05D9 E5              PUSH  HL
1050   05DA C5              PUSH  BC
1051   05DB             
1052   05DB E5              PUSH  HL
1053   05DC E5              PUSH  HL
1054   05DD E5              PUSH  HL
1055   05DE             
1056   05DE 7D              LD  A, L
1057   05DF 21 A8 06        LD	HL, LED_FONT
1058   05E2 E6 0F           AND $0F
1059   05E4 01 00 00        LD      BC, 0
1060   05E7 4F              LD      C, A
1061   05E8 09              ADD HL, BC
1062   05E9 7E              LD  A, (HL)
1063   05EA 21 07 FF        LD  HL, DIG_7
1064   05ED 77              LD  (HL), A
1065   05EE             
1066   05EE E1              POP  HL
1067   05EF 7D              LD  A, L
1068   05F0 21 A8 06        LD	HL, LED_FONT
1069   05F3 E6 F0           AND  $F0
1070   05F5 CB 0F           RRC  A
1071   05F7 CB 0F           RRC  A
1072   05F9 CB 0F           RRC  A
1073   05FB CB 0F           RRC  A
1074   05FD 01 00 00        LD      BC, 0
1075   0600 4F              LD      C, A
1076   0601 09              ADD HL, BC
1077   0602 7E              LD  A, (HL)
1078   0603 21 06 FF        LD  HL, DIG_6
1079   0606 77              LD  (HL), A
1080   0607             
1081   0607 E1              POP  HL
1082   0608 7C              LD  A, H
1083   0609 21 A8 06        LD	HL, LED_FONT
1084   060C E6 0F           AND $0F
1085   060E 01 00 00        LD      BC, 0
1086   0611 4F              LD      C, A
1087   0612 09              ADD HL, BC
1088   0613 7E              LD  A, (HL)
1089   0614 21 05 FF        LD  HL, DIG_5
1090   0617 77              LD  (HL), A
1091   0618             
1092   0618 E1              POP  HL
1093   0619 7C              LD  A, H
1094   061A 21 A8 06        LD	HL, LED_FONT
1095   061D E6 F0           AND  $F0
1096   061F CB 0F           RRC  A
1097   0621 CB 0F           RRC  A
1098   0623 CB 0F           RRC  A
1099   0625 CB 0F           RRC  A
1100   0627 01 00 00        LD      BC, 0
1101   062A 4F              LD      C, A
1102   062B 09              ADD HL, BC
1103   062C 7E              LD  A, (HL)
1104   062D 21 04 FF        LD  HL, DIG_4
1105   0630 77              LD  (HL), A
1106   0631             
1107   0631 C1              POP  BC
1108   0632 E1              POP  HL
1109   0633 F1              POP  AF
1110   0634             
1111   0634 C9              RET
1112   0635             
1113   0635             ; =========================================================
1114   0635             ; Start Sistem ?
1115   0635             ; =========================================================
1116   0635             START:
1117   0635 31 00 FF        LD  SP, STACK
1118   0638 21 00 80        LD  HL, START_RAM
1119   063B 22 0D FF        LD  (PC_RAM), HL
1120   063E             
1121   063E                 ; start vars
1122   063E 3E 64           LD  A, CKEY_TIMEOUT
1123   0640 32 0B FF        LD  (KEY_TIMEOUT), A
1124   0643             
1125   0643 3E 01           LD  A, 1                 ; Monitor mode
1126   0645 32 0F FF        LD  (SYSMODE), A
1127   0648             
1128   0648 3E FF           LD A, $FF
1129   064A 32 08 FF        LD (KEY_PRESS), A
1130   064D             
1131   064D ED 56           IM  1
1132   064F FB              EI
1133   0650             
1134   0650 AF              XOR A
1135   0651 D3 40           OUT (Port40), A
1136   0653             
1137   0653             
1138   0653 3E 00           LD  A, $00
1139   0655 32 00 FF        LD  (DIG_0), A
1140   0658             
1141   0658 3E 00           LD  A, $00
1142   065A 32 01 FF        LD  (DIG_1), A
1143   065D             
1144   065D 3E 00           LD  A, $0
1145   065F 32 02 FF        LD  (DIG_2), A
1146   0662             
1147   0662 3E 00           LD  A, $00
1148   0664 32 03 FF        LD  (DIG_3), A
1149   0667             
1150   0667 3E 00           LD  A, $00
1151   0669 32 04 FF        LD  (DIG_4), A
1152   066C             
1153   066C 3E 00           LD  A, $00
1154   066E 32 05 FF        LD  (DIG_5), A
1155   0671             
1156   0671 3E 00           LD  A, $00
1157   0673 32 06 FF        LD  (DIG_6), A
1158   0676             
1159   0676 3E 00           LD  A, $00
1160   0678 32 07 FF        LD  (DIG_7), A
1161   067B             
1162   067B             START_LOOP:
1163   067B             
1164   067B C3 7B 06        JP START_LOOP
1165   067E             
1166   067E             
1167   067E             
1168   067E             
1169   067E             
1170   067E             
1171   067E             
1172   067E             
1173   067E             
1174   067E             ; =========================================================
1175   067E             ; Delay
1176   067E             ; =========================================================
1177   067E             delay:
1178   067E C5          	push bc                       ; 2.75 us
1179   067F 06 FF           ld b, 255                     ; 1.75 us
1180   0681             delay_loop_b:
1181   0681 0E FF       	ld c, 255                     ; 1.75 us
1182   0683             delay_loop:
1183   0683 0D          	dec c                         ; 1 us
1184   0684 C2 83 06        jp nz, delay_loop             ; true = 3 us, false 1.75 us
1185   0687 05              dec b                         ; 1 us
1186   0688 C2 81 06        jp nz, delay_loop_b           ; true = 3 us, false 1.75 us
1187   068B C1              pop bc                        ; 2.50 us
1188   068C C9              ret                           ; 2.50 us
1189   068D             
1190   068D             
1191   068D             ;============================================================================
1192   068D             ;	Subroutine	Delay_A
1193   068D             ;
1194   068D             ;	Entry:	A = Millisecond count
1195   068D             ;============================================================================
1196   068D E5          DELAY_A:	PUSH	HL			; Save count
1197   068E 21 10 FF    		LD	HL,TicCounter
1198   0691 86          		ADD	A,(HL)			; A = cycle count
1199   0692 BE          DlyLp		CP	(HL)			; Wait required TicCounter times
1200   0693 C2 92 06    		JP	NZ,DlyLp		;  loop if not done
1201   0696 E1          		POP	HL
1202   0697 C9          		RET
1203   0698             
1204   0698             
1205   0698 0E 01       DELAY_100mS	LD	C,1
1206   069A C5          DELAY_C		PUSH	BC
1207   069B 06 00       		LD	B,0
1208   069D C5          DELAY_LP	PUSH	BC
1209   069E 10 FE       		DJNZ	$		;13   * 256 / 4 = 832uSec
1210   06A0 C1          		POP	BC
1211   06A1 10 FA       		DJNZ	DELAY_LP	;~100mSEC
1212   06A3 0D          		DEC	C
1213   06A4 20 F7       		JR  NZ,	DELAY_LP	;*4 ~= 7mSec
1214   06A6 C1          		POP	BC
1215   06A7 C9          		RET
1216   06A8             
1217   06A8             ; Mapa char to display 0-F
1218   06A8 3F065B4F666DLED_FONT .db $3F, $06, $5B, $4F, $66, $6D, $7D, $07, $7F, $67 ; 0-9
1218   06AE 7D077F67
1219   06B2 777C395E7971         .DB $77, $7C, $39, $5E, $79, $71                     ; A-F
1220   06B8             
1221   06B8             
1222   06B8             
1223   06B8             ; ---------------------------------------------------------
1224   06B8             ; RAM MAP - Utilitys Program | $FE00 - $FEFF
1225   06B8             ; ---------------------------------------------------------
1226   06B8             DIEGO      .equ    $FE00   ;(2) Temp Digits to countDown
1227   06B8             
1228   06B8             BLINK_TESTE:
1229   06B8 3E 01           LD  A, 1
1230   06BA             BLINK_TESTE_LOOP:
1231   06BA EE 01           XOR 1
1232   06BC D3 C0           OUT (PortC0), A 
1233   06BE C3 BA 06        JP BLINK_TESTE_LOOP
1234   06C1             
1235   06C1             
1236   06C1             BLINK_DELAY_C:
1237   06C1 3E 01           LD  A, 1
1238   06C3             BLINK_DELAY_C_LOOP:
1239   06C3 EE 01           XOR 1
1240   06C5 D3 C0           OUT (PortC0), A
1241   06C7 CD 98 06        CALL DELAY_100mS
1242   06CA C3 C3 06        JP BLINK_DELAY_C_LOOP
1243   06CD             
1244   06CD             
1245   06CD             BLINK_DELAY_A:
1246   06CD 3E 01           LD  A, 1
1247   06CF             BLINK_DELAY_A_LOOP:
1248   06CF EE 01           XOR 1
1249   06D1 D3 C0           OUT (PortC0), A
1250   06D3 F5              PUSH  AF
1251   06D4 3E 64           LD  A, 100
1252   06D6 CD 8D 06        CALL DELAY_A
1253   06D9 F1              POP AF
1254   06DA C3 CF 06        JP BLINK_DELAY_A_LOOP
1255   06DD             
1256   06DD             
1257   06DD             
1258   06DD             TESTE_SOM:
1259   06DD 3E 00           LD  A, 0
1260   06DF 32 0F FF        LD  (SYSMODE), A
1261   06E2 3E 00           LD  A, 0
1262   06E4 47              LD  B, A
1263   06E5 CD 09 05        CALL CLEAR_USER_DISPLAY
1264   06E8 3E 6D           LD  A, $6D ; S
1265   06EA 32 D0 FF        LD  (USER_DISP0), A
1266   06ED 3E 3F           LD  A, $3F ; O
1267   06EF 32 D1 FF        LD  (USER_DISP1), A
1268   06F2 3E 1C           LD  A, $1C ; U
1269   06F4 32 D2 FF        LD  (USER_DISP2), A
1270   06F7 3E 54           LD  A, $54 ; N
1271   06F9 32 D3 FF        LD  (USER_DISP3), A
1272   06FC 3E 5E           LD  A, $5E ; D
1273   06FE 32 D4 FF        LD  (USER_DISP4), A
1274   0701             LOOP_SOM:
1275   0701 78              LD  A, B
1276   0702 CD 26 05        CALL GET_NUM_FROM_LOW
1277   0705 32 D7 FF        LD  (USER_DISP7), A
1278   0708 78              LD  A, B
1279   0709 CD 36 05        CALL GET_NUM_FROM_HIGH
1280   070C 32 D6 FF        LD  (USER_DISP6), A
1281   070F             
1282   070F CD 61 03        CALL GET_KEY_A
1283   0712 FE 0A           CP  $0A
1284   0714 CA 24 07        JP  Z, SOM_INC
1285   0717 FE 0B           CP  $0B
1286   0719 CA 2F 07        JP  Z, SOM_DEC
1287   071C FE 0F           CP  $0F
1288   071E CA 3A 07        JP  Z, SOM_LOOP_INC
1289   0721 C3 01 07        JP  LOOP_SOM
1290   0724             
1291   0724             
1292   0724             SOM_INC:
1293   0724 04              INC B
1294   0725 0E C0           LD  C, $C0
1295   0727 ED 41           OUT (C), B
1296   0729 CD 98 06        CALL DELAY_100mS
1297   072C C3 01 07        JP  LOOP_SOM
1298   072F             
1299   072F             SOM_DEC:
1300   072F 05              DEC B
1301   0730 0E C0           LD  C, $C0
1302   0732 ED 41           OUT (C), B
1303   0734 CD 98 06        CALL DELAY_100mS
1304   0737 C3 01 07        JP  LOOP_SOM
1305   073A             
1306   073A             SOM_LOOP_INC:
1307   073A 78              LD  A, B
1308   073B CD 26 05        CALL GET_NUM_FROM_LOW
1309   073E 32 D7 FF        LD  (USER_DISP7), A
1310   0741 78              LD  A, B
1311   0742 CD 36 05        CALL GET_NUM_FROM_HIGH
1312   0745 32 D6 FF        LD  (USER_DISP6), A
1313   0748 04              INC B
1314   0749 0E C0           LD  C, $C0
1315   074B ED 41           OUT (C), B
1316   074D CD 98 06        CALL DELAY_100mS
1317   0750 CD 98 06        CALL DELAY_100mS
1318   0753 C3 3A 07        JP  SOM_LOOP_INC
1319   0756             
1320   0756             
1321   0756             
1322   0756             
1323   0756             
1324   0756             
1325   0756             
1326   0756             
1327   0756             
1328   0756             
1329   1000             .org $1000
1330   1000 CD 09 05        CALL CLEAR_USER_DISPLAY
1331   1003 3E 00           LD  A, 0                 ; user mode
1332   1005 32 0F FF        LD (SYSMODE), A
1333   1008             
1334   1008 06 08           LD  B, $08
1335   100A 21 D0 FF        LD  HL, USER_DISP0
1336   100D 3E 08           LD  A, 8
1337   100F             
1338   100F             LEDS_LOOP:
1339   100F CD 09 05        CALL CLEAR_USER_DISPLAY
1340   1012 70              LD  (HL), B
1341   1013 CD 98 06        CALL DELAY_100mS
1342   1016 23              INC HL
1343   1017 3D              DEC A
1344   1018 FE 00           CP 0
1345   101A C2 0F 10        JP NZ, LEDS_LOOP
1346   101D             
1347   101D 3E 08           LD A, 8
1348   101F 21 D7 FF        LD  HL, USER_DISP7
1349   1022 06 40           LD  B, $40
1350   1024             
1351   1024             LEDS_LOOP2:
1352   1024 CD 09 05        CALL CLEAR_USER_DISPLAY
1353   1027 70              LD  (HL), B
1354   1028 CD 98 06        CALL DELAY_100mS
1355   102B 2B              DEC HL
1356   102C 3D              DEC A
1357   102D FE 00           CP 0
1358   102F C2 24 10        JP NZ, LEDS_LOOP2
1359   1032             
1360   1032 3E 08           LD  A, 8
1361   1034 21 D0 FF        LD  HL, USER_DISP0
1362   1037 06 08           LD  B, $08
1363   1039 C3 0F 10        JP LEDS_LOOP
1364   103C             
1365   103C             
1366   103C             
1367   103C             
1368   103C             
1369   103C             
1370   103C             
1371   103C             
1372   103C             
1373   103C             
1374   4000             .org $4000
1375   4000             
1376   4000                 ; timer count down
1377   4000             
1378   4000 CD 09 05        CALL CLEAR_USER_DISPLAY
1379   4003 3E 39           LD  A, $39
1380   4005 32 D0 FF        LD  (USER_DISP0), A
1381   4008             
1382   4008 3E 3F           LD  A, $3F
1383   400A 32 D1 FF        LD  (USER_DISP1), A
1384   400D             
1385   400D 3E 1C           LD  A, $1C
1386   400F 32 D2 FF        LD  (USER_DISP2), A
1387   4012             
1388   4012 3E 54           LD  A, $54
1389   4014 32 D3 FF        LD  (USER_DISP3), A
1390   4017             
1391   4017 3E 78           LD  A, $78
1392   4019 32 D4 FF        LD  (USER_DISP4), A
1393   401C             
1394   401C 3E 00           LD  A, $00
1395   401E 32 D5 FF        LD  (USER_DISP5), A
1396   4021             
1397   4021             
1398   4021             
1399   4021 3E 40           LD  A, $40
1400   4023 32 D6 FF        LD  (USER_DISP6), A
1401   4026             
1402   4026 3E 40           LD  A, $40
1403   4028 32 D7 FF        LD  (USER_DISP7), A
1404   402B             
1405   402B 3E 00           LD  A, 0                 ; user mode
1406   402D 32 0F FF        LD (SYSMODE), A
1407   4030             
1408   4030             READ:
1409   4030 CD 61 03        CALL GET_KEY_A
1410   4033 FE FF           CP  $FF
1411   4035 CA 30 40        JP  Z, READ
1412   4038             
1413   4038 CD 49 40        CALL  MODIFY_KEY_POS_1D
1414   403B             
1415   403B             READ2
1416   403B CD 61 03        CALL GET_KEY_A
1417   403E FE FF           CP  $FF
1418   4040 CA 3B 40        JP  Z, READ2
1419   4043             
1420   4043 CD 55 40        CALL MODIFY_KEY_POS_0D
1421   4046             
1422   4046 C3 60 40        JP  LOOP
1423   4049             
1424   4049             
1425   4049             MODIFY_KEY_POS_1D:
1426   4049 21 00 FE        LD  HL, DIEGO
1427   404C 23              INC HL
1428   404D 77              LD  (HL), A
1429   404E CD 26 05        CALL GET_NUM_FROM_LOW
1430   4051 32 D6 FF        LD  (USER_DISP6), A
1431   4054 C9              RET
1432   4055             
1433   4055             MODIFY_KEY_POS_0D:
1434   4055 21 00 FE        LD  HL, DIEGO
1435   4058 77              LD  (HL), A
1436   4059 CD 26 05        CALL GET_NUM_FROM_LOW
1437   405C 32 D7 FF        LD  (USER_DISP7), A
1438   405F C9              RET
1439   4060             
1440   4060             LOOP:
1441   4060 2A 00 FE        LD  HL, (DIEGO)
1442   4063             
1443   4063             LOOP_DOWN:
1444   4063 7C              LD  A, H
1445   4064 CD 26 05        CALL GET_NUM_FROM_LOW
1446   4067 32 D6 FF        LD  (USER_DISP6), A
1447   406A             
1448   406A 7D              LD  A, L
1449   406B CD 26 05        CALL GET_NUM_FROM_LOW
1450   406E 32 D7 FF        LD  (USER_DISP7), A
1451   4071             
1452   4071 0E 07           LD C, 7    ; 10 x 100ms = 1seg
1453   4073 CD 9A 06        CALL DELAY_C
1454   4076             
1455   4076 7D              LD A, L
1456   4077 FE 00           CP 0
1457   4079 CA 81 40        JP Z, DEC_H
1458   407C 3D              DEC A
1459   407D 6F              LD L, A
1460   407E C3 63 40        JP LOOP_DOWN
1461   4081             
1462   4081             DEC_H:
1463   4081 7C              LD  A, H
1464   4082 FE 00           CP 0
1465   4084 CA 8F 40        JP Z, CHECK_L
1466   4087 3D              DEC A
1467   4088 67              LD H, A
1468   4089 3E 09           LD A, 9
1469   408B 6F              LD L, A
1470   408C C3 63 40        JP LOOP_DOWN
1471   408F             
1472   408F             CHECK_L:
1473   408F 7D              LD  A, L
1474   4090 FE 00           CP 0
1475   4092 CA 95 40        JP Z, BEEP
1476   4095             
1477   4095             BEEP:
1478   4095 3E 80           LD  A, $80
1479   4097 D3 C0           OUT  (PortC0), A
1480   4099 CD 98 06        CALL DELAY_100mS
1481   409C             
1482   409C 3E C0           LD  A, $C0
1483   409E D3 C0           OUT  (PortC0), A
1484   40A0 CD 98 06        CALL DELAY_100mS
1485   40A3 C3 95 40        JP BEEP
1486   40A6             
1487   40A6             
1488   40A6             
1489   40A6             
1490   40A6             
1491   40A6             
1492   40A6             .end
1493   40A6             
1494   40A6             ; =========================================================
1495   40A6             ; Tabela display
1496   40A6             ; =========================================================
1497   40A6             ; 
1498   40A6             ;   0 - $3F
1499   40A6             ;   1 - $06
1500   40A6             ;   2 - $5B
1501   40A6             ;   3 - $4F
1502   40A6             ;   4 - $66
1503   40A6             ;   5 - $6D
1504   40A6             ;   6 - $7D
1505   40A6             ;   7 - $07
1506   40A6             ;   8 - $7F
1507   40A6             ;   9 - $67
1508   40A6             ; 
1509   40A6             ;   A - $77
1510   40A6             ;   B - $7C
1511   40A6             ;   C - $39
1512   40A6             ;   D - $5E
1513   40A6             ;   E - $79
1514   40A6             ;   F - $71
1515   40A6             ;   G - $6F
1516   40A6             ;   H - $76
1517   40A6             ;   I - $06
1518   40A6             ;   J - $1E
1519   40A6             ;   K - $7A
1520   40A6             ;   L - $38
1521   40A6             ;   M - $37
1522   40A6             ;   N - $54
1523   40A6             ;   O - $3F
1524   40A6             ;   P - $73
1525   40A6             ;   Q - $67
1526   40A6             ;   R - $50
1527   40A6             ;   S - $6D
1528   40A6             ;   T - $78
1529   40A6             ;   U - $1C
1530   40A6             ;   V - $3E
1531   40A6             ;   W - $1D
1532   40A6             ;   X - $70
1533   40A6             ;   Y - $6E
1534   40A6             ;   Z - $49
1535   40A6             
1536   40A6             ;   + - $46
1537   40A6             ;   , - $04
1538   40A6             ;   - - $40
1539   40A6             ;   . - $80
1540   40A6             ;   Ñ - $55
1541   40A6             ;   : - $41
1542   40A6             ;   ; - $88
1543   40A6             ;   _ - $08
tasm: Number of errors = 0
