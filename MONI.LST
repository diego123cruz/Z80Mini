0001   0000             ; ---------------------------------------------------------
0002   0000             ;   Z80 Mini  -  inicio 01/2022
0003   0000             ;   Diego Cruz - github.com/diego123cruz
0004   0000             ;
0005   0000             ;   Hardware baseado em: http://www.sunrise-ev.com/z80.htm
0006   0000             ;   Software próprio - em construção
0007   0000             ; ---------------------------------------------------------
0008   0000             ;   Z80@4Mhz
0009   0000             ;   ROM 32k - 28C256
0010   0000             ;   RAM 32k - 65256
0011   0000             ;   Display 7 segmentos 8 digitos
0012   0000             ;   Teclado 16 teclas + Fn (Tecla de função? ou outra coisa?)
0013   0000             ;   Entrada 40h
0014   0000             ;   Saida 40h
0015   0000             ;
0016   0000             ;
0017   0000             ; ---------------------------------------------------------
0018   0000             ;   Display 7 Segmentos - In(Port40) AND 00000111b
0019   0000             ; ---------------------------------------------------------
0020   0000             ;
0021   0000             ;   ------------------------------------------------
0022   0000             ;   | 00h | 01h | 02h | 03h | 04h | 05h | 06h | 07h |
0023   0000             ;   ------------------------------------------------
0024   0000             ;
0025   0000             ;               A(0)
0026   0000             ;            ---------
0027   0000             ;           |         |
0028   0000             ;      F(5) |         | B(1)
0029   0000             ;           |   G(6)  |
0030   0000             ;            ---------
0031   0000             ;           |         |
0032   0000             ;      E(4) |         | C(2)
0033   0000             ;           |         |
0034   0000             ;            ---------         Ponto(7)
0035   0000             ;               D(3) 
0036   0000             ;
0037   0000             ;
0038   0000             ;
0039   0000             ;
0040   0000             ;
0041   0000             ; ---------------------------------------------------------
0042   0000             ; Teclado 
0043   0000             ; ---------------------------------------------------------
0044   0000             ;   
0045   0000             ;   Keys:        
0046   0000             ;       Fn - In(Port40) AND 00010000b - pulldown
0047   0000             ;       0 - In(Port40) AND 00000111b
0048   0000             ;
0049   0000             ;
0050   0000             ;
0051   0000             ;
0052   0000             
0053   0000             
0054   0000             ; ---------------------------------------------------------
0055   0000             ; Constantes
0056   0000             ; ---------------------------------------------------------
0057   0000             
0058   0000             Port40        .equ    $40
0059   0000             START_RAM     .equ    $8000
0060   0000             STACK         .equ    $FF00  
0061   0000             CKEY_TIMEOUT  .equ    100  ; 100ms +-
0062   0000             
0063   0000             ; ---------------------------------------------------------
0064   0000             ; RAM MAP - Monitor | $FF00 - $FF2F
0065   0000             ; ---------------------------------------------------------
0066   0000             ; Cada digito fica em um ponto da memoria RAM
0067   0000             DIG_0       .equ    $FF00   ;(1) endereço do digito 0 na memoria RAM
0068   0000             DIG_1       .equ    $FF01   ;(1) endereço do digito 1 na memoria RAM
0069   0000             DIG_2       .equ    $FF02   ;(1) endereço do digito 2 na memoria RAM
0070   0000             DIG_3       .equ    $FF03   ;(1) endereço do digito 3 na memoria RAM
0071   0000             DIG_4       .equ    $FF04   ;(1) endereço do digito 4 na memoria RAM
0072   0000             DIG_5       .equ    $FF05   ;(1) endereço do digito 5 na memoria RAM
0073   0000             DIG_6       .equ    $FF06   ;(1) endereço do digito 6 na memoria RAM
0074   0000             DIG_7       .equ    $FF07   ;(1) endereço do digito 7 na memoria RAM
0075   0000             KEY_PRESS   .equ    $FF08   ;(1) key atual
0076   0000             INPUT       .equ    $FF09   ;(1) temp input from int
0077   0000             TMP_KEY     .equ    $FF0A   ;(1) tmp key
0078   0000             KEY_TIMEOUT .equ    $FF0B   ;(1) tempo para retornar a tecla, CKEY_TIMEOUT
0079   0000             BUZZER      .equ    $FF0C   ;(1) buzzer state != 0 - Ativo, 0 - Desativado
0080   0000             PC_RAM      .equ    $FF0D   ;(2) save pc to user start $8000
0081   0000             
0082   0000             SYSMODE     .equ    $FF0F   ;(1) System mode. 
0083   0000                                         ; 0 - User Mode
0084   0000                                         ; 1 - Monitor
0085   0000                                         ; 2 - Examine Memoria
0086   0000                                         ; 3 - Change Data(Memory)
0087   0000                                         ; 4 - Show register PC
0088   0000                                         ; 5 - Show register SP
0089   0000                                         ; 6 - Show register AF
0090   0000                                         ; 7 - Show register BC
0091   0000                                         ; 8 - Show register DE
0092   0000                                         ; 9 - Show register HL
0093   0000             TicCounter  .equ    $FF10   ;(2) TicCounter inc 1ms
0094   0000             EXM_COUNT   .equ    $FF12   ;(1) Count digits Examine function, 4 digits
0095   0000             MDF_COUNT   .equ    $FF13   ;(1) Count digits moDify function, 2 digits
0096   0000             USR_PC      .equ    $FF14   ;(2) PC 
0097   0000             USR_SP      .equ    $FF16   ;(2) SP
0098   0000             USR_AF      .equ    $FF18   ;(2) AF
0099   0000             USR_BC      .equ    $FF1A   ;(2) BC
0100   0000             USR_DE      .equ    $FF1C   ;(2) DE
0101   0000             USR_HL      .equ    $FF1E   ;(2) HL
0102   0000             
0103   0000             ; Copy USER_DISPx to DIG_x WHEN USER_MODE
0104   0000             USER_DISP0  .equ    $FF20   ; Mode User - Display Dig 0  - 01234567
0105   0000             USER_DISP1  .equ    $FF21   ; Mode User - Display Dig 1  - 01234567
0106   0000             USER_DISP2  .equ    $FF22   ; Mode User - Display Dig 2  - 01234567
0107   0000             USER_DISP3  .equ    $FF23   ; Mode User - Display Dig 3  - 01234567
0108   0000             USER_DISP4  .equ    $FF24   ; Mode User - Display Dig 4  - 01234567
0109   0000             USER_DISP5  .equ    $FF25   ; Mode User - Display Dig 5  - 01234567
0110   0000             USER_DISP6  .equ    $FF26   ; Mode User - Display Dig 6  - 01234567
0111   0000             USER_DISP7  .equ    $FF27   ; Mode User - Display Dig 7  - 01234567
0112   0000             
0113   0000             
0114   0000             
0115   0000             
0116   0000             ; =========================================================
0117   0000             ; Start ROM
0118   0000             ; =========================================================
0119   0000             .org    $0000
0120   0000 C3 D8 06        JP  START
0121   0003             
0122   0003             ; =========================================================
0123   0003             ; Livre para colocar funções 0003h - 0037h 
0124   0003             ; =========================================================
0125   0003             
0126   0003             ; delay_100ms
0127   0003             
0128   0003             ; char7segFromA
0129   0003             
0130   0003             ; animacaoLeds
0131   0003             
0132   0003             ; Limpar RAM (FF).... etc
0133   0003             
0134   0003             
0135   0003             ; =========================================================
0136   0003             ; Int 38h
0137   0003             ; =========================================================
0138   0038             .org    $38
0139   0038 F3              DI
0140   0039             
0141   0039                 ; save registers ?
0142   0039 E5              PUSH  HL
0143   003A F5              PUSH  AF
0144   003B C5              PUSH  BC
0145   003C D5              PUSH  DE
0146   003D             
0147   003D 22 1E FF        LD  (USR_HL), HL
0148   0040                 
0149   0040                 ; Save DE
0150   0040 E1              POP  HL
0151   0041 22 1C FF        LD  (USR_DE), HL
0152   0044             
0153   0044                 ; Save BC
0154   0044 E1              POP  HL
0155   0045 22 1A FF        LD  (USR_BC), HL
0156   0048             
0157   0048                 ; Save AF
0158   0048 E1              POP  HL
0159   0049 22 18 FF        LD  (USR_AF), HL
0160   004C             
0161   004C E1              POP  HL
0162   004D             
0163   004D             
0164   004D             
0165   004D                 ; normal
0166   004D 08              EX  AF, AF'
0167   004E D9              EXX
0168   004F             
0169   004F                 ; Save SP
0170   004F E3              EX (SP), HL
0171   0050 22 16 FF        LD (USR_SP), HL
0172   0053 E3              EX (SP), HL
0173   0054             
0174   0054                 ; Save PC
0175   0054 E1              POP HL
0176   0055 22 14 FF        LD  (USR_PC), HL
0177   0058             
0178   0058                 ; TicCounter
0179   0058 2A 10 FF        LD  HL, (TicCounter)
0180   005B 23              INC  HL
0181   005C 22 10 FF        LD  (TicCounter), HL
0182   005F             
0183   005F                 ; Timeout Key
0184   005F 3A 0B FF        LD A, (KEY_TIMEOUT)
0185   0062 FE 00           CP 0
0186   0064 CA 6B 00        JP Z, ENTER_SYS
0187   0067 3D              DEC A
0188   0068 32 0B FF        LD (KEY_TIMEOUT), A
0189   006B             
0190   006B             
0191   006B             ENTER_SYS:
0192   006B CD 7A 00        CALL    TRATAMENTO_INT38H   
0193   006E C3 0A 02        JP      SYS_MAIN
0194   0071             
0195   0071             EXIT_SYS:
0196   0071                 ; Restore PC
0197   0071 2A 14 FF        LD  HL, (USR_PC)
0198   0074 E5              PUSH  HL
0199   0075             
0200   0075 D9              EXX
0201   0076 08              EX  AF, AF'
0202   0077 FB              EI
0203   0078 ED 4D           RETI
0204   007A             
0205   007A             
0206   007A             
0207   007A             ; =========================================================
0208   007A             ; Tratamento Int 38h
0209   007A             ; =========================================================
0210   007A             TRATAMENTO_INT38H:
0211   007A              
0212   007A DB 40           IN A, (Port40)
0213   007C 32 09 FF        LD  (INPUT), A
0214   007F E6 07           AND $07                  ; 00000111b
0215   0081 FE 00           CP  0
0216   0083 CA AA 00        JP  Z, Col0
0217   0086 FE 01           CP  1
0218   0088 CA D4 00        JP  Z, Col1
0219   008B FE 02           CP  2
0220   008D CA FE 00        JP  Z, Col2
0221   0090 FE 03           CP  3
0222   0092 CA 28 01        JP  Z, Col3
0223   0095 FE 04           CP  4
0224   0097 CA 52 01        JP  Z, Col4
0225   009A FE 05           CP  5
0226   009C CA 7C 01        JP  Z, Col5
0227   009F FE 06           CP  6
0228   00A1 CA A6 01        JP  Z, Col6
0229   00A4 FE 07           CP  7
0230   00A6 CA D0 01        JP  Z, Col7
0231   00A9 C9              RET
0232   00AA             
0233   00AA             Col0:
0234   00AA 3A 09 FF        LD  A,  (INPUT)
0235   00AD CB 5F           BIT  3, A
0236   00AF C2 BC 00        JP  NZ, Col0_nextA
0237   00B2 3E 00           LD  A, $00
0238   00B4 32 08 FF        LD  (KEY_PRESS), A
0239   00B7 3E 64           LD A, CKEY_TIMEOUT
0240   00B9 32 0B FF        LD (KEY_TIMEOUT), A
0241   00BC             Col0_nextA:
0242   00BC 3A 09 FF        LD  A,  (INPUT)
0243   00BF CB 67           BIT  4, A
0244   00C1 C2 CE 00        JP  NZ, Col0_next
0245   00C4 3E 0E           LD  A, $0E
0246   00C6 32 08 FF        LD  (KEY_PRESS), A
0247   00C9 3E 64           LD A, CKEY_TIMEOUT
0248   00CB 32 0B FF        LD (KEY_TIMEOUT), A
0249   00CE             Col0_next:
0250   00CE 3A 01 FF        LD  A, (DIG_1)           ; Dig_0
0251   00D1 D3 40           out (Port40), a
0252   00D3 C9              RET
0253   00D4             
0254   00D4             
0255   00D4             Col1:
0256   00D4 3A 09 FF        LD  A,  (INPUT)
0257   00D7 CB 5F           BIT  3, A
0258   00D9 C2 E6 00        JP  NZ, Col1_nextA
0259   00DC 3E 01           LD  A, $01
0260   00DE 32 08 FF        LD  (KEY_PRESS), A
0261   00E1 3E 64           LD A, CKEY_TIMEOUT
0262   00E3 32 0B FF        LD (KEY_TIMEOUT), A
0263   00E6             Col1_nextA:
0264   00E6 3A 09 FF        LD  A,  (INPUT)
0265   00E9 CB 67           BIT  4, A
0266   00EB C2 F8 00        JP  NZ, Col1_next
0267   00EE 3E 03           LD  A, $03
0268   00F0 32 08 FF        LD  (KEY_PRESS), A
0269   00F3 3E 64           LD A, CKEY_TIMEOUT
0270   00F5 32 0B FF        LD (KEY_TIMEOUT), A
0271   00F8             Col1_next:
0272   00F8 3A 02 FF        LD  A, (DIG_2)           ; Dig_1
0273   00FB D3 40           out (Port40), a
0274   00FD C9              RET
0275   00FE             
0276   00FE             Col2:
0277   00FE 3A 09 FF        LD  A,  (INPUT)
0278   0101 CB 5F           BIT  3, A
0279   0103 C2 10 01        JP  NZ, Col2_nextA
0280   0106 3E 04           LD  A, $04
0281   0108 32 08 FF        LD  (KEY_PRESS), A
0282   010B 3E 64           LD A, CKEY_TIMEOUT
0283   010D 32 0B FF        LD (KEY_TIMEOUT), A
0284   0110             Col2_nextA:
0285   0110 3A 09 FF        LD  A,  (INPUT)
0286   0113 CB 67           BIT  4, A
0287   0115 C2 22 01        JP  NZ, Col2_next
0288   0118 3E 06           LD  A, $06
0289   011A 32 08 FF        LD  (KEY_PRESS), A
0290   011D 3E 64           LD A, CKEY_TIMEOUT
0291   011F 32 0B FF        LD (KEY_TIMEOUT), A
0292   0122             Col2_next:
0293   0122 3A 03 FF        LD  A, (DIG_3)           ; Dig_2
0294   0125 D3 40           out (Port40), a
0295   0127 C9              RET
0296   0128             
0297   0128             Col3:
0298   0128 3A 09 FF        LD  A,  (INPUT)
0299   012B CB 5F           BIT  3, A
0300   012D C2 3A 01        JP  NZ, Col3_nextA
0301   0130 3E 07           LD  A, $07
0302   0132 32 08 FF        LD  (KEY_PRESS), A
0303   0135 3E 64           LD A, CKEY_TIMEOUT
0304   0137 32 0B FF        LD (KEY_TIMEOUT), A
0305   013A             Col3_nextA:
0306   013A 3A 09 FF        LD  A,  (INPUT)
0307   013D CB 67           BIT  4, A
0308   013F C2 4C 01        JP  NZ, Col3_next
0309   0142 3E 09           LD  A, $09
0310   0144 32 08 FF        LD  (KEY_PRESS), A
0311   0147 3E 64           LD A, CKEY_TIMEOUT
0312   0149 32 0B FF        LD (KEY_TIMEOUT), A
0313   014C             Col3_next:
0314   014C 3A 04 FF        LD  A, (DIG_4)           ; Dig_3
0315   014F D3 40           out (Port40), a
0316   0151 C9              RET
0317   0152             
0318   0152             Col4:
0319   0152 3A 09 FF        LD  A,  (INPUT)
0320   0155 CB 5F           BIT  3, A
0321   0157 C2 64 01        JP  NZ, Col4_nextA
0322   015A 3E 0F           LD  A, $0F
0323   015C 32 08 FF        LD  (KEY_PRESS), A
0324   015F 3E 64           LD A, CKEY_TIMEOUT
0325   0161 32 0B FF        LD (KEY_TIMEOUT), A
0326   0164             Col4_nextA:
0327   0164 3A 09 FF        LD  A,  (INPUT)
0328   0167 CB 67           BIT  4, A
0329   0169 C2 76 01        JP  NZ, Col4_next
0330   016C 3E 0D           LD  A, $0D
0331   016E 32 08 FF        LD  (KEY_PRESS), A
0332   0171 3E 64           LD A, CKEY_TIMEOUT
0333   0173 32 0B FF        LD (KEY_TIMEOUT), A
0334   0176             Col4_next:
0335   0176 3A 05 FF        LD  A, (DIG_5)           ; Dig_4
0336   0179 D3 40           out (Port40), a
0337   017B C9              RET
0338   017C             
0339   017C             Col5:
0340   017C 3A 09 FF        LD  A,  (INPUT)
0341   017F CB 5F           BIT  3, A
0342   0181 C2 8E 01        JP  NZ, Col5_nextA
0343   0184 3E 02           LD  A, $02
0344   0186 32 08 FF        LD  (KEY_PRESS), A
0345   0189 3E 64           LD A, CKEY_TIMEOUT
0346   018B 32 0B FF        LD (KEY_TIMEOUT), A
0347   018E             Col5_nextA:
0348   018E 3A 09 FF        LD  A,  (INPUT)
0349   0191 CB 67           BIT  4, A
0350   0193 C2 A0 01        JP  NZ, Col5_next
0351   0196 3E 0C           LD  A, $0C
0352   0198 32 08 FF        LD  (KEY_PRESS), A
0353   019B 3E 64           LD A, CKEY_TIMEOUT
0354   019D 32 0B FF        LD (KEY_TIMEOUT), A
0355   01A0             Col5_next:
0356   01A0 3A 06 FF        LD  A, (DIG_6)           ; Dig_5
0357   01A3 D3 40           out (Port40), a
0358   01A5 C9              RET
0359   01A6             
0360   01A6             Col6:
0361   01A6 3A 09 FF        LD  A,  (INPUT)
0362   01A9 CB 5F           BIT  3, A
0363   01AB C2 B8 01        JP  NZ, Col6_nextA
0364   01AE 3E 05           LD  A, $05
0365   01B0 32 08 FF        LD  (KEY_PRESS), A
0366   01B3 3E 64           LD A, CKEY_TIMEOUT
0367   01B5 32 0B FF        LD (KEY_TIMEOUT), A
0368   01B8             Col6_nextA:
0369   01B8 3A 09 FF        LD  A,  (INPUT)
0370   01BB CB 67           BIT  4, A
0371   01BD C2 CA 01        JP  NZ, Col6_next
0372   01C0 3E 0B           LD  A, $0B
0373   01C2 32 08 FF        LD  (KEY_PRESS), A
0374   01C5 3E 64           LD A, CKEY_TIMEOUT
0375   01C7 32 0B FF        LD (KEY_TIMEOUT), A
0376   01CA             Col6_next:
0377   01CA 3A 07 FF        LD  A, (DIG_7)           ; Dig_6
0378   01CD D3 40           out (Port40), a
0379   01CF C9              RET
0380   01D0             
0381   01D0             Col7:
0382   01D0 3A 09 FF        LD  A,  (INPUT)
0383   01D3 CB 5F           BIT  3, A
0384   01D5 C2 E2 01        JP  NZ, Col7_nextA
0385   01D8 3E 08           LD  A, $08
0386   01DA 32 08 FF        LD  (KEY_PRESS), A
0387   01DD 3E 64           LD A, CKEY_TIMEOUT
0388   01DF 32 0B FF        LD (KEY_TIMEOUT), A
0389   01E2             Col7_nextA:
0390   01E2 3A 09 FF        LD  A,  (INPUT)
0391   01E5 CB 67           BIT  4, A
0392   01E7 C2 F4 01        JP  NZ, Col7_next
0393   01EA 3E 0A           LD  A, $0A
0394   01EC 32 08 FF        LD  (KEY_PRESS), A
0395   01EF 3E 64           LD A, CKEY_TIMEOUT
0396   01F1 32 0B FF        LD (KEY_TIMEOUT), A
0397   01F4             Col7_next:
0398   01F4 3A 0C FF        LD  A, (BUZZER)
0399   01F7 FE 00           CP  0
0400   01F9 C2 02 02        JP  NZ, LIGA_BUZZER
0401   01FC 3A 00 FF        LD  A, (DIG_0)           ; Dig_7
0402   01FF D3 40           out (Port40), a
0403   0201 C9              RET
0404   0202             LIGA_BUZZER:
0405   0202 3A 00 FF        LD  A, (DIG_0)
0406   0205 F6 80           OR  $80
0407   0207 D3 40           OUT  (Port40), A
0408   0209 C9              RET
0409   020A             
0410   020A             ; =========================================================
0411   020A             ; SYS MAIN
0412   020A             ; =========================================================
0413   020A             SYS_MAIN:
0414   020A 3A 0F FF        LD  A, (SYSMODE)
0415   020D FE 00           CP  0                    ; User mode can back to monitor
0416   020F CA 32 04        JP  Z, USER_MODE        
0417   0212             
0418   0212 3A 0F FF        LD  A, (SYSMODE)
0419   0215 FE 01           CP  1                    ; monitor
0420   0217 CA 48 04        JP  Z, MONITOR_MODE
0421   021A             
0422   021A 3A 0F FF        LD  A,  (SYSMODE)
0423   021D FE 02           CP  2                    ; Examine RAM
0424   021F CA 5D 02        JP  Z, EXAMINE_RAM
0425   0222             
0426   0222 3A 0F FF        LD  A, (SYSMODE)
0427   0225 FE 03           CP  3                    ; Modify Data (Memory)
0428   0227 CA F6 02        JP  Z,  MODIFY_RAM
0429   022A             
0430   022A 3A 0F FF        LD  A, (SYSMODE)
0431   022D FE 04           CP  4                    ; Show register PC
0432   022F CA 45 03        JP  Z,  SHOW_REG_PC
0433   0232             
0434   0232 3A 0F FF        LD  A, (SYSMODE)
0435   0235 FE 05           CP  5                    ; Show register SP
0436   0237 CA 68 03        JP  Z,  SHOW_REG_SP
0437   023A             
0438   023A 3A 0F FF        LD  A, (SYSMODE)
0439   023D FE 06           CP  6                    ; Show register AF
0440   023F CA 8B 03        JP  Z,  SHOW_REG_AF
0441   0242             
0442   0242 3A 0F FF        LD  A, (SYSMODE)
0443   0245 FE 07           CP  7                    ; Show register BC
0444   0247 CA AE 03        JP  Z,  SHOW_REG_BC
0445   024A             
0446   024A 3A 0F FF        LD  A, (SYSMODE)
0447   024D FE 08           CP  8                    ; Show register DE
0448   024F CA D1 03        JP  Z,  SHOW_REG_DE
0449   0252             
0450   0252 3A 0F FF        LD  A, (SYSMODE)
0451   0255 FE 09           CP  9                    ; Show register HL
0452   0257 CA F4 03        JP  Z,  SHOW_REG_HL
0453   025A             
0454   025A             
0455   025A C3 71 00        JP  EXIT_SYS
0456   025D             
0457   025D             
0458   025D             ; =========================================================
0459   025D             ; Examine RAM Mode
0460   025D             ; =========================================================
0461   025D             EXAMINE_RAM:
0462   025D CD 17 04        CALL GET_KEY_A
0463   0260 FE FF           CP  $FF
0464   0262 CA 71 00        JP  Z, EXIT_SYS
0465   0265             
0466   0265 F5              PUSH  AF
0467   0266 F5              PUSH  AF
0468   0267 3A 12 FF        LD  A, (EXM_COUNT)
0469   026A FE 03           CP  3
0470   026C CA 8A 02        JP  Z, EXAMINE_KEY_POS_3
0471   026F             
0472   026F 3A 12 FF        LD  A, (EXM_COUNT)
0473   0272 FE 02           CP  2
0474   0274 CA A8 02        JP  Z, EXAMINE_KEY_POS_2
0475   0277             
0476   0277 3A 12 FF        LD  A, (EXM_COUNT)
0477   027A FE 01           CP  1
0478   027C CA C2 02        JP  Z, EXAMINE_KEY_POS_1
0479   027F             
0480   027F 3A 12 FF        LD  A, (EXM_COUNT)
0481   0282 FE 00           CP  0
0482   0284 CA E3 02        JP  Z, EXAMINE_KEY_POS_0
0483   0287             
0484   0287 C3 71 00        JP  EXIT_SYS
0485   028A             
0486   028A             EXAMINE_KEY_POS_3:
0487   028A F1              POP  AF
0488   028B CB 07           RLC  A
0489   028D CB 07           RLC  A
0490   028F CB 07           RLC  A
0491   0291 CB 07           RLC  A
0492   0293 67              LD  H, A
0493   0294 22 0D FF        LD  (PC_RAM), HL
0494   0297 F1              POP  AF
0495   0298 CD C9 05        CALL GET_NUM_FROM_LOW
0496   029B 32 00 FF        LD  (DIG_0), A
0497   029E 3A 12 FF        LD  A, (EXM_COUNT)
0498   02A1 3D              DEC A
0499   02A2 32 12 FF        LD  (EXM_COUNT), A
0500   02A5 C3 71 00        JP  EXIT_SYS
0501   02A8             
0502   02A8             
0503   02A8             EXAMINE_KEY_POS_2:
0504   02A8 F1              POP  AF
0505   02A9 2A 0D FF        LD  HL, (PC_RAM)
0506   02AC B4              OR  H
0507   02AD 67              LD  H, A
0508   02AE 22 0D FF        LD  (PC_RAM), HL
0509   02B1 F1              POP  AF
0510   02B2 CD C9 05        CALL GET_NUM_FROM_LOW
0511   02B5 32 01 FF        LD  (DIG_1), A
0512   02B8 3A 12 FF        LD  A, (EXM_COUNT)
0513   02BB 3D              DEC A
0514   02BC 32 12 FF        LD  (EXM_COUNT), A
0515   02BF C3 71 00        JP  EXIT_SYS
0516   02C2             
0517   02C2             EXAMINE_KEY_POS_1:
0518   02C2 F1              POP  AF
0519   02C3 2A 0D FF        LD  HL, (PC_RAM)
0520   02C6 CB 07           RLC  A
0521   02C8 CB 07           RLC  A
0522   02CA CB 07           RLC  A
0523   02CC CB 07           RLC  A
0524   02CE 6F              LD  L, A
0525   02CF 22 0D FF        LD  (PC_RAM), HL
0526   02D2 F1              POP  AF
0527   02D3 CD C9 05        CALL GET_NUM_FROM_LOW
0528   02D6 32 02 FF        LD  (DIG_2), A
0529   02D9 3A 12 FF        LD  A, (EXM_COUNT)
0530   02DC 3D              DEC A
0531   02DD 32 12 FF        LD  (EXM_COUNT), A
0532   02E0 C3 71 00        JP  EXIT_SYS
0533   02E3             
0534   02E3             
0535   02E3             EXAMINE_KEY_POS_0:
0536   02E3 F1              POP  AF
0537   02E4 2A 0D FF        LD  HL, (PC_RAM)
0538   02E7 B5              OR  L
0539   02E8 6F              LD  L, A
0540   02E9 22 0D FF        LD  (PC_RAM), HL
0541   02EC F1              POP  AF
0542   02ED CD C9 05        CALL GET_NUM_FROM_LOW
0543   02F0 32 03 FF        LD  (DIG_3), A
0544   02F3 C3 21 05        JP  GO_MONITOR
0545   02F6             
0546   02F6             ; =========================================================
0547   02F6             ; MODIFY RAM Mode
0548   02F6             ; =========================================================
0549   02F6             MODIFY_RAM:
0550   02F6             
0551   02F6 CD 17 04        CALL GET_KEY_A
0552   02F9 FE FF           CP  $FF
0553   02FB CA 71 00        JP  Z, EXIT_SYS
0554   02FE             
0555   02FE F5              PUSH  AF
0556   02FF F5              PUSH  AF
0557   0300 3A 13 FF        LD  A, (MDF_COUNT)
0558   0303 FE 01           CP  1
0559   0305 CA 13 03        JP  Z, MODIFY_KEY_POS_1
0560   0308             
0561   0308 3A 13 FF        LD  A, (MDF_COUNT)
0562   030B FE 00           CP  0
0563   030D CA 31 03        JP  Z, MODIFY_KEY_POS_0
0564   0310             
0565   0310 C3 71 00        JP  EXIT_SYS
0566   0313             
0567   0313             MODIFY_KEY_POS_1:
0568   0313 F1              POP  AF
0569   0314 CB 07           RLC  A
0570   0316 CB 07           RLC  A
0571   0318 CB 07           RLC  A
0572   031A CB 07           RLC  A
0573   031C 2A 0D FF        LD  HL, (PC_RAM)
0574   031F 77              LD  (HL), A
0575   0320             
0576   0320 F1              POP  AF
0577   0321 CD C9 05        CALL GET_NUM_FROM_LOW
0578   0324 32 06 FF        LD  (DIG_6), A
0579   0327 3A 13 FF        LD  A, (MDF_COUNT)
0580   032A 3D              DEC A
0581   032B 32 13 FF        LD  (MDF_COUNT), A
0582   032E C3 71 00        JP  EXIT_SYS
0583   0331             
0584   0331             MODIFY_KEY_POS_0:
0585   0331 F1              POP  AF
0586   0332 2A 0D FF        LD  HL, (PC_RAM)
0587   0335 46              LD  B, (HL)
0588   0336 B0              OR  B
0589   0337 2A 0D FF        LD  HL, (PC_RAM)
0590   033A 77              LD  (HL), A
0591   033B             
0592   033B F1              POP  AF
0593   033C CD C9 05        CALL GET_NUM_FROM_LOW
0594   033F 32 07 FF        LD  (DIG_7), A
0595   0342 C3 21 05        JP  GO_MONITOR
0596   0345                 
0597   0345             
0598   0345               
0599   0345             
0600   0345             SHOW_REG_PC:
0601   0345 CD 17 04        CALL  GET_KEY_A
0602   0348 FE 00           CP  0
0603   034A CA 21 05        JP Z, GO_MONITOR
0604   034D CD 8F 05        CALL  CLEAR_DISPLAY
0605   0350             
0606   0350 3E 50           LD  A, $50               ; R
0607   0352 32 00 FF        LD  (DIG_0), A
0608   0355             
0609   0355 3E 73           LD  A, $73               ; P
0610   0357 32 01 FF        LD  (DIG_1), A
0611   035A             
0612   035A 3E 39           LD  A, $39
0613   035C 32 02 FF        LD  (DIG_2), A           ; C
0614   035F             
0615   035F 2A 14 FF        LD HL, (USR_PC)
0616   0362 CD 7B 06        CALL PRINT_END_HL
0617   0365 C3 71 00        JP  EXIT_SYS
0618   0368             
0619   0368             
0620   0368             SHOW_REG_SP:
0621   0368 CD 17 04        CALL  GET_KEY_A
0622   036B FE 00           CP  0
0623   036D CA 21 05        JP Z, GO_MONITOR
0624   0370             
0625   0370 CD 8F 05        CALL  CLEAR_DISPLAY
0626   0373             
0627   0373 3E 50           LD  A, $50               ; R
0628   0375 32 00 FF        LD  (DIG_0), A
0629   0378             
0630   0378 3E 6D           LD  A, $6D               ; S
0631   037A 32 01 FF        LD  (DIG_1), A
0632   037D             
0633   037D 3E 73           LD  A, $73               ; P
0634   037F 32 02 FF        LD  (DIG_2), A
0635   0382             
0636   0382 2A 16 FF        LD HL, (USR_SP)
0637   0385 CD 7B 06        CALL PRINT_END_HL
0638   0388 C3 71 00        JP  EXIT_SYS
0639   038B             
0640   038B             
0641   038B             SHOW_REG_AF:
0642   038B CD 17 04        CALL  GET_KEY_A
0643   038E FE 00           CP  0
0644   0390 CA 21 05        JP Z, GO_MONITOR
0645   0393 CD 8F 05        CALL  CLEAR_DISPLAY
0646   0396             
0647   0396 3E 50           LD  A, $50               ; R
0648   0398 32 00 FF        LD  (DIG_0), A
0649   039B             
0650   039B 3E 77           LD  A, $77               ; A
0651   039D 32 01 FF        LD  (DIG_1), A
0652   03A0             
0653   03A0 3E 71           LD  A, $71               ; F
0654   03A2 32 02 FF        LD  (DIG_2), A
0655   03A5             
0656   03A5 2A 18 FF        LD HL, (USR_AF)
0657   03A8 CD 7B 06        CALL PRINT_END_HL
0658   03AB C3 71 00        JP  EXIT_SYS
0659   03AE             
0660   03AE             
0661   03AE             SHOW_REG_BC:
0662   03AE CD 17 04        CALL  GET_KEY_A
0663   03B1 FE 00           CP  0
0664   03B3 CA 21 05        JP Z, GO_MONITOR
0665   03B6 CD 8F 05        CALL  CLEAR_DISPLAY
0666   03B9             
0667   03B9 3E 50           LD  A, $50               ; R
0668   03BB 32 00 FF        LD  (DIG_0), A
0669   03BE             
0670   03BE 3E 7C           LD  A, $7C               ; B
0671   03C0 32 01 FF        LD  (DIG_1), A
0672   03C3             
0673   03C3 3E 39           LD  A, $39               ; C
0674   03C5 32 02 FF        LD  (DIG_2), A
0675   03C8             
0676   03C8 2A 1A FF        LD HL, (USR_BC)
0677   03CB CD 7B 06        CALL PRINT_END_HL
0678   03CE C3 71 00        JP  EXIT_SYS
0679   03D1             
0680   03D1             SHOW_REG_DE:
0681   03D1 CD 17 04        CALL  GET_KEY_A
0682   03D4 FE 00           CP  0
0683   03D6 CA 21 05        JP Z, GO_MONITOR
0684   03D9 CD 8F 05        CALL  CLEAR_DISPLAY
0685   03DC             
0686   03DC 3E 50           LD  A, $50               ; R
0687   03DE 32 00 FF        LD  (DIG_0), A
0688   03E1             
0689   03E1 3E 5E           LD  A, $5E               ; D
0690   03E3 32 01 FF        LD  (DIG_1), A
0691   03E6             
0692   03E6 3E 79           LD  A, $79               ; E
0693   03E8 32 02 FF        LD  (DIG_2), A
0694   03EB             
0695   03EB 2A 1C FF        LD HL, (USR_DE)
0696   03EE CD 7B 06        CALL PRINT_END_HL
0697   03F1 C3 71 00        JP  EXIT_SYS
0698   03F4             
0699   03F4             SHOW_REG_HL:
0700   03F4 CD 17 04        CALL  GET_KEY_A
0701   03F7 FE 00           CP  0
0702   03F9 CA 21 05        JP Z, GO_MONITOR
0703   03FC CD 8F 05        CALL  CLEAR_DISPLAY
0704   03FF             
0705   03FF 3E 50           LD  A, $50               ; R
0706   0401 32 00 FF        LD  (DIG_0), A
0707   0404             
0708   0404 3E 76           LD  A, $76               ; H
0709   0406 32 01 FF        LD  (DIG_1), A
0710   0409             
0711   0409 3E 38           LD  A, $38               ; L
0712   040B 32 02 FF        LD  (DIG_2), A
0713   040E             
0714   040E 2A 1E FF        LD HL, (USR_HL)
0715   0411 CD 7B 06        CALL PRINT_END_HL
0716   0414 C3 71 00        JP  EXIT_SYS
0717   0417             
0718   0417             
0719   0417             ; =========================================================
0720   0417             ; GET KEY IN A, IF A == FFh then no KEY
0721   0417             ; =========================================================
0722   0417             GET_KEY_A:
0723   0417 3A 0B FF        LD  A, (KEY_TIMEOUT)
0724   041A FE 00           CP  0
0725   041C CA 22 04        JP  Z, RET_KEY
0726   041F 3E FF           LD  A, $FF
0727   0421 C9              RET
0728   0422             
0729   0422             RET_KEY:
0730   0422 3E 64           LD A, CKEY_TIMEOUT
0731   0424 32 0B FF        LD (KEY_TIMEOUT), A
0732   0427             
0733   0427 3A 08 FF        LD  A, (KEY_PRESS)
0734   042A F5              PUSH  AF
0735   042B 3E FF           LD  A, $FF
0736   042D 32 08 FF        LD  (KEY_PRESS), A
0737   0430 F1              POP  AF
0738   0431 C9              RET
0739   0432             
0740   0432             
0741   0432             ; =========================================================
0742   0432             ; MONITOR Mode
0743   0432             ; =========================================================
0744   0432             USER_MODE:
0745   0432 3A 09 FF        LD  A, (INPUT)
0746   0435 FE FB           CP  $FB
0747   0437 CA 21 05        JP  Z, GO_MONITOR
0748   043A                 
0749   043A                 ; Copy USER_DISPx to DIG_x
0750   043A 21 20 FF        LD	HL, USER_DISP0
0751   043D 11 00 FF    	LD	DE, DIG_0
0752   0440 01 08 00    	LD	BC, $0008
0753   0443 ED B0       	LDIR
0754   0445             
0755   0445 C3 71 00        JP  EXIT_SYS
0756   0448             
0757   0448             MONITOR_MODE:
0758   0448                 ; Mostra o endereço
0759   0448 2A 0D FF        LD  HL, (PC_RAM)
0760   044B CD 1E 06        CALL PRINT_HL
0761   044E             
0762   044E                 ; Limpa digitos
0763   044E 3E 00           LD  A, 0
0764   0450 32 04 FF        LD  (DIG_4), A
0765   0453 32 05 FF        LD  (DIG_5), A
0766   0456             
0767   0456                 ; Mostra os dados no endereço
0768   0456 2A 0D FF        LD  HL, (PC_RAM)
0769   0459 7E              LD  A, (HL)
0770   045A CD F1 05        CALL  PRINT_A
0771   045D             
0772   045D             
0773   045D CD 17 04        CALL  GET_KEY_A
0774   0460             
0775   0460                 ; Incrementa endereço
0776   0460 32 0A FF        LD (TMP_KEY), A
0777   0463 FE 0A           CP  $0A
0778   0465 CA DD 04        JP  Z,  PC_RAM_INC
0779   0468             
0780   0468                 ; Decrementa endereço
0781   0468 3A 0A FF        LD  A, (TMP_KEY)
0782   046B FE 0B           CP  $0B
0783   046D CA D3 04        JP  Z,  PC_RAM_DEC
0784   0470             
0785   0470                 ; Examina memoria
0786   0470 3A 0A FF        LD  A, (TMP_KEY)
0787   0473 FE 0E           CP  $0E
0788   0475 CA E7 04        JP  Z,  GO_EXAMINE
0789   0478             
0790   0478                 ; + moDify Memory
0791   0478 3A 0A FF        LD  A, (TMP_KEY)
0792   047B FE 0C           CP  $0C
0793   047D CA 02 05        JP  Z,  GO_ADD_MODIFY
0794   0480             
0795   0480                 ; moDify Memory
0796   0480 3A 0A FF        LD  A, (TMP_KEY)
0797   0483 FE 0D           CP  $0D
0798   0485 CA 0C 05        JP  Z,  GO_MODIFY
0799   0488             
0800   0488                 ; RUN
0801   0488 3A 0A FF        LD  A, (TMP_KEY)
0802   048B FE 0F           CP  $0F
0803   048D CA 6E 05        JP  Z,  FIRE
0804   0490             
0805   0490                 ; Show register PC
0806   0490 3A 0A FF        LD  A, (TMP_KEY)
0807   0493 FE 01           CP  $01
0808   0495 CA 2C 05        JP  Z, GO_SHOW_REG_PC
0809   0498             
0810   0498                 ; Show register SP
0811   0498 3A 0A FF        LD  A, (TMP_KEY)
0812   049B FE 02           CP  $02
0813   049D CA 37 05        JP  Z, GO_SHOW_REG_SP
0814   04A0             
0815   04A0                 ; Show register AF
0816   04A0 3A 0A FF        LD  A, (TMP_KEY)
0817   04A3 FE 03           CP  $03
0818   04A5 CA 42 05        JP  Z, GO_SHOW_REG_AF
0819   04A8             
0820   04A8                 ; Show register BC
0821   04A8 3A 0A FF        LD  A, (TMP_KEY)
0822   04AB FE 04           CP  $04
0823   04AD CA 4D 05        JP  Z, GO_SHOW_REG_BC
0824   04B0             
0825   04B0                 ; Show register DE
0826   04B0 3A 0A FF        LD  A, (TMP_KEY)
0827   04B3 FE 05           CP  $05
0828   04B5 CA 58 05        JP  Z, GO_SHOW_REG_DE
0829   04B8             
0830   04B8                 ; Show register HL
0831   04B8 3A 0A FF        LD  A, (TMP_KEY)
0832   04BB FE 06           CP  $06
0833   04BD CA 63 05        JP  Z, GO_SHOW_REG_HL
0834   04C0             
0835   04C0                 ; BUZZER TOGGLE
0836   04C0 3A 0A FF        LD  A, (TMP_KEY)
0837   04C3 FE 07           CP  $07
0838   04C5 CA 7C 05        JP  Z,  BUZZER_TOGGLE
0839   04C8             
0840   04C8                 ; Back to user mode
0841   04C8 3A 0A FF        LD  A, (TMP_KEY)
0842   04CB FE 09           CP  $09
0843   04CD CA 87 05        JP  Z, GO_USER_MODE
0844   04D0             
0845   04D0 C3 71 00        JP  EXIT_SYS
0846   04D3                 
0847   04D3             
0848   04D3             PC_RAM_DEC:
0849   04D3 2A 0D FF        LD  HL, (PC_RAM)
0850   04D6 2B              DEC  HL
0851   04D7 22 0D FF        LD  (PC_RAM), HL
0852   04DA C3 71 00        JP  EXIT_SYS
0853   04DD             
0854   04DD             PC_RAM_INC:
0855   04DD 2A 0D FF        LD  HL, (PC_RAM)
0856   04E0 23              INC  HL
0857   04E1 22 0D FF        LD  (PC_RAM), HL
0858   04E4 C3 71 00        JP  EXIT_SYS
0859   04E7             
0860   04E7             GO_EXAMINE:
0861   04E7 3E 03           LD  A, 3
0862   04E9 32 12 FF        LD (EXM_COUNT), A        ; Set count 4 digits, position display
0863   04EC 3E 02           LD  A, 2
0864   04EE 32 0F FF        LD (SYSMODE), A          ; Examine mode
0865   04F1 3E 40           LD A, 01000000b
0866   04F3 32 00 FF        LD (DIG_0), A
0867   04F6 32 01 FF        LD (DIG_1), A
0868   04F9 32 02 FF        LD (DIG_2), A
0869   04FC 32 03 FF        LD (DIG_3), A
0870   04FF C3 71 00        JP  EXIT_SYS
0871   0502             
0872   0502             GO_ADD_MODIFY:
0873   0502 2A 0D FF        LD  HL, (PC_RAM)
0874   0505 23              INC HL
0875   0506 22 0D FF        LD  (PC_RAM), HL
0876   0509 CD 1E 06        CALL  PRINT_HL
0877   050C             GO_MODIFY:
0878   050C 3E 01           LD  A, 1                 ; Set count 2 digits, position display
0879   050E 32 13 FF        LD  (MDF_COUNT), A
0880   0511 3E 03           LD  A, 3                 ; moDify mode (Memory)
0881   0513 32 0F FF        LD  (SYSMODE), A
0882   0516 3E 40           LD  A, 01000000b
0883   0518 32 06 FF        LD  (DIG_6), A
0884   051B 32 07 FF        LD  (DIG_7), A
0885   051E C3 71 00        JP  EXIT_SYS
0886   0521             
0887   0521             GO_MONITOR:
0888   0521 CD 8F 05        CALL  CLEAR_DISPLAY
0889   0524 3E 01           LD  A, 1
0890   0526 32 0F FF        LD  (SYSMODE), A
0891   0529 C3 71 00        JP  EXIT_SYS
0892   052C             
0893   052C             GO_SHOW_REG_PC:
0894   052C CD 8F 05        CALL CLEAR_DISPLAY
0895   052F 3E 04           LD  A, 4
0896   0531 32 0F FF        LD  (SYSMODE), A
0897   0534 C3 71 00        JP  EXIT_SYS
0898   0537             
0899   0537             GO_SHOW_REG_SP:
0900   0537 CD 8F 05        CALL CLEAR_DISPLAY
0901   053A 3E 05           LD  A, 5
0902   053C 32 0F FF        LD  (SYSMODE), A
0903   053F C3 71 00        JP  EXIT_SYS
0904   0542             
0905   0542             GO_SHOW_REG_AF:
0906   0542 CD 8F 05        CALL CLEAR_DISPLAY
0907   0545 3E 06           LD  A, 6
0908   0547 32 0F FF        LD  (SYSMODE), A
0909   054A C3 71 00        JP  EXIT_SYS
0910   054D             
0911   054D             GO_SHOW_REG_BC:
0912   054D CD 8F 05        CALL CLEAR_DISPLAY
0913   0550 3E 07           LD  A, 7
0914   0552 32 0F FF        LD  (SYSMODE), A
0915   0555 C3 71 00        JP  EXIT_SYS
0916   0558             
0917   0558             GO_SHOW_REG_DE:
0918   0558 CD 8F 05        CALL CLEAR_DISPLAY
0919   055B 3E 08           LD  A, 8
0920   055D 32 0F FF        LD  (SYSMODE), A
0921   0560 C3 71 00        JP  EXIT_SYS
0922   0563             
0923   0563             GO_SHOW_REG_HL:
0924   0563 CD 8F 05        CALL CLEAR_DISPLAY
0925   0566 3E 09           LD  A, 9
0926   0568 32 0F FF        LD  (SYSMODE), A
0927   056B C3 71 00        JP  EXIT_SYS
0928   056E             
0929   056E             
0930   056E             FIRE:
0931   056E 3E 01           LD  A, 1
0932   0570 32 0F FF        LD (SYSMODE), A          ; Monitor mode
0933   0573 2A 0D FF        LD  HL, (PC_RAM)
0934   0576 22 14 FF        LD  (USR_PC), HL
0935   0579 C3 71 00        JP  EXIT_SYS
0936   057C             
0937   057C             BUZZER_TOGGLE:
0938   057C 3A 0C FF        LD  A, (BUZZER)
0939   057F EE 01           XOR 1
0940   0581 32 0C FF        LD  (BUZZER), A
0941   0584 C3 71 00        JP  EXIT_SYS
0942   0587             
0943   0587             GO_USER_MODE:
0944   0587 3E 00           LD  A, 0
0945   0589 32 0F FF        LD  (SYSMODE), A
0946   058C C3 71 00        JP  EXIT_SYS
0947   058F             
0948   058F             ; =========================================================
0949   058F             ; LIMPA DISPLAY
0950   058F             ; =========================================================
0951   058F             CLEAR_DISPLAY:
0952   058F F5              PUSH  AF
0953   0590 3E 00           LD  A, 0
0954   0592 32 00 FF        LD  (DIG_0), A
0955   0595 32 01 FF        LD  (DIG_1), A
0956   0598 32 02 FF        LD  (DIG_2), A
0957   059B 32 03 FF        LD  (DIG_3), A
0958   059E 32 04 FF        LD  (DIG_4), A
0959   05A1 32 05 FF        LD  (DIG_5), A
0960   05A4 32 06 FF        LD  (DIG_6), A
0961   05A7 32 07 FF        LD  (DIG_7), A
0962   05AA F1              POP  AF
0963   05AB C9              RET
0964   05AC             
0965   05AC             ; =========================================================
0966   05AC             ; LIMPA USER DISPLAY
0967   05AC             ; =========================================================
0968   05AC             CLEAR_USER_DISPLAY:
0969   05AC F5              PUSH  AF
0970   05AD 3E 00           LD  A, 0
0971   05AF 32 20 FF        LD  (USER_DISP0), A
0972   05B2 32 21 FF        LD  (USER_DISP1), A
0973   05B5 32 22 FF        LD  (USER_DISP2), A
0974   05B8 32 23 FF        LD  (USER_DISP3), A
0975   05BB 32 24 FF        LD  (USER_DISP4), A
0976   05BE 32 25 FF        LD  (USER_DISP5), A
0977   05C1 32 26 FF        LD  (USER_DISP6), A
0978   05C4 32 27 FF        LD  (USER_DISP7), A
0979   05C7 F1              POP  AF
0980   05C8 C9              RET
0981   05C9             
0982   05C9             
0983   05C9             ; =========================================================
0984   05C9             ; PEGA LOW NUM EM A E RETORNA CHAR 7SEG EM A
0985   05C9             ; =========================================================
0986   05C9             GET_NUM_FROM_LOW:
0987   05C9 E5              PUSH    HL
0988   05CA C5              PUSH    BC
0989   05CB 21 50 07        LD      HL, LED_FONT
0990   05CE E6 0F           AND     $0F
0991   05D0 01 00 00        LD      BC, 0
0992   05D3 4F              LD      C, A
0993   05D4 09              ADD     HL, BC
0994   05D5 7E              LD      A, (HL)
0995   05D6 C1              POP     BC
0996   05D7 E1              POP     HL
0997   05D8 C9              RET
0998   05D9             
0999   05D9             ; =========================================================
1000   05D9             ; PEGA HIGH NUM EM A E RETORNA CHAR 7SEG EM A
1001   05D9             ; =========================================================
1002   05D9             GET_NUM_FROM_HIGH:
1003   05D9 E5              PUSH    HL
1004   05DA C5              PUSH    BC
1005   05DB 21 50 07        LD      HL, LED_FONT
1006   05DE E6 F0           AND     $F0
1007   05E0 CB 0F           RRC     A
1008   05E2 CB 0F           RRC     A
1009   05E4 CB 0F           RRC     A
1010   05E6 CB 0F           RRC     A
1011   05E8 01 00 00        LD      BC, 0
1012   05EB 4F              LD      C, A
1013   05EC 09              ADD     HL, BC
1014   05ED 7E              LD      A, (HL)
1015   05EE C1              POP     BC
1016   05EF E1              POP     HL
1017   05F0 C9              RET
1018   05F1             
1019   05F1             ; =========================================================
1020   05F1             ; Mostra o que esta em A nos digitos 6 e 7
1021   05F1             ; =========================================================
1022   05F1             PRINT_A:
1023   05F1 E5              PUSH    HL
1024   05F2 C5              PUSH    BC
1025   05F3 F5              PUSH    AF
1026   05F4 F5              PUSH    AF
1027   05F5             
1028   05F5 21 50 07        LD	HL, LED_FONT
1029   05F8 E6 0F           AND $0F
1030   05FA 01 00 00        LD      BC, 0
1031   05FD 4F              LD      C, A
1032   05FE 09              ADD HL, BC
1033   05FF 7E              LD  A, (HL)
1034   0600 32 07 FF        LD  (DIG_7), A
1035   0603             
1036   0603 F1              POP    AF
1037   0604 21 50 07        LD	HL, LED_FONT
1038   0607 E6 F0           AND  $F0
1039   0609 CB 0F           RRC  A
1040   060B CB 0F           RRC  A
1041   060D CB 0F           RRC  A
1042   060F CB 0F           RRC  A
1043   0611 01 00 00        LD      BC, 0
1044   0614 4F              LD      C, A
1045   0615 09              ADD HL, BC
1046   0616 7E              LD  A, (HL)
1047   0617 32 06 FF        LD  (DIG_6), A
1048   061A             
1049   061A F1              POP     AF
1050   061B C1              POP     BC
1051   061C E1              POP     HL
1052   061D C9              RET
1053   061E             
1054   061E             ; =========================================================
1055   061E             ; Mostra o que esta em HL - Display(HHLLXXXX)
1056   061E             ; =========================================================
1057   061E             PRINT_HL:
1058   061E F5              PUSH  AF
1059   061F E5              PUSH  HL
1060   0620 C5              PUSH  BC
1061   0621             
1062   0621 E5              PUSH  HL
1063   0622 E5              PUSH  HL
1064   0623 E5              PUSH  HL
1065   0624             
1066   0624 7D              LD  A, L
1067   0625 21 50 07        LD	HL, LED_FONT
1068   0628 E6 0F           AND $0F
1069   062A 01 00 00        LD      BC, 0
1070   062D 4F              LD      C, A
1071   062E 09              ADD HL, BC
1072   062F 7E              LD  A, (HL)
1073   0630 21 03 FF        LD  HL, DIG_3
1074   0633 77              LD  (HL), A
1075   0634             
1076   0634 E1              POP  HL
1077   0635 7D              LD  A, L
1078   0636 21 50 07        LD	HL, LED_FONT
1079   0639 E6 F0           AND  $F0
1080   063B CB 0F           RRC  A
1081   063D CB 0F           RRC  A
1082   063F CB 0F           RRC  A
1083   0641 CB 0F           RRC  A
1084   0643 01 00 00        LD      BC, 0
1085   0646 4F              LD      C, A
1086   0647 09              ADD HL, BC
1087   0648 7E              LD  A, (HL)
1088   0649 21 02 FF        LD  HL, DIG_2
1089   064C 77              LD  (HL), A
1090   064D             
1091   064D E1              POP  HL
1092   064E 7C              LD  A, H
1093   064F 21 50 07        LD	HL, LED_FONT
1094   0652 E6 0F           AND $0F
1095   0654 01 00 00        LD      BC, 0
1096   0657 4F              LD      C, A
1097   0658 09              ADD HL, BC
1098   0659 7E              LD  A, (HL)
1099   065A 21 01 FF        LD  HL, DIG_1
1100   065D 77              LD  (HL), A
1101   065E             
1102   065E E1              POP  HL
1103   065F 7C              LD  A, H
1104   0660 21 50 07        LD	HL, LED_FONT
1105   0663 E6 F0           AND  $F0
1106   0665 CB 0F           RRC  A
1107   0667 CB 0F           RRC  A
1108   0669 CB 0F           RRC  A
1109   066B CB 0F           RRC  A
1110   066D 01 00 00        LD      BC, 0
1111   0670 4F              LD      C, A
1112   0671 09              ADD HL, BC
1113   0672 7E              LD  A, (HL)
1114   0673 21 00 FF        LD  HL, DIG_0
1115   0676 77              LD  (HL), A
1116   0677             
1117   0677 C1              POP  BC
1118   0678 E1              POP  HL
1119   0679 F1              POP  AF
1120   067A             
1121   067A C9              RET
1122   067B             
1123   067B             ; =========================================================
1124   067B             ; Mostra o que esta em HL - Display(XXXXHHLL)
1125   067B             ; =========================================================
1126   067B             PRINT_END_HL:
1127   067B F5              PUSH  AF
1128   067C E5              PUSH  HL
1129   067D C5              PUSH  BC
1130   067E             
1131   067E E5              PUSH  HL
1132   067F E5              PUSH  HL
1133   0680 E5              PUSH  HL
1134   0681             
1135   0681 7D              LD  A, L
1136   0682 21 50 07        LD	HL, LED_FONT
1137   0685 E6 0F           AND $0F
1138   0687 01 00 00        LD      BC, 0
1139   068A 4F              LD      C, A
1140   068B 09              ADD HL, BC
1141   068C 7E              LD  A, (HL)
1142   068D 21 07 FF        LD  HL, DIG_7
1143   0690 77              LD  (HL), A
1144   0691             
1145   0691 E1              POP  HL
1146   0692 7D              LD  A, L
1147   0693 21 50 07        LD	HL, LED_FONT
1148   0696 E6 F0           AND  $F0
1149   0698 CB 0F           RRC  A
1150   069A CB 0F           RRC  A
1151   069C CB 0F           RRC  A
1152   069E CB 0F           RRC  A
1153   06A0 01 00 00        LD      BC, 0
1154   06A3 4F              LD      C, A
1155   06A4 09              ADD HL, BC
1156   06A5 7E              LD  A, (HL)
1157   06A6 21 06 FF        LD  HL, DIG_6
1158   06A9 77              LD  (HL), A
1159   06AA             
1160   06AA E1              POP  HL
1161   06AB 7C              LD  A, H
1162   06AC 21 50 07        LD	HL, LED_FONT
1163   06AF E6 0F           AND $0F
1164   06B1 01 00 00        LD      BC, 0
1165   06B4 4F              LD      C, A
1166   06B5 09              ADD HL, BC
1167   06B6 7E              LD  A, (HL)
1168   06B7 21 05 FF        LD  HL, DIG_5
1169   06BA 77              LD  (HL), A
1170   06BB             
1171   06BB E1              POP  HL
1172   06BC 7C              LD  A, H
1173   06BD 21 50 07        LD	HL, LED_FONT
1174   06C0 E6 F0           AND  $F0
1175   06C2 CB 0F           RRC  A
1176   06C4 CB 0F           RRC  A
1177   06C6 CB 0F           RRC  A
1178   06C8 CB 0F           RRC  A
1179   06CA 01 00 00        LD      BC, 0
1180   06CD 4F              LD      C, A
1181   06CE 09              ADD HL, BC
1182   06CF 7E              LD  A, (HL)
1183   06D0 21 04 FF        LD  HL, DIG_4
1184   06D3 77              LD  (HL), A
1185   06D4             
1186   06D4 C1              POP  BC
1187   06D5 E1              POP  HL
1188   06D6 F1              POP  AF
1189   06D7             
1190   06D7 C9              RET
1191   06D8             
1192   06D8             ; =========================================================
1193   06D8             ; Start Sistem ?
1194   06D8             ; =========================================================
1195   06D8             START:
1196   06D8 31 00 FF        LD  SP, STACK
1197   06DB 21 00 80        LD  HL, START_RAM
1198   06DE 22 0D FF        LD  (PC_RAM), HL
1199   06E1             
1200   06E1                 ; start vars
1201   06E1 3E 64           LD  A, CKEY_TIMEOUT
1202   06E3 32 0B FF        LD  (KEY_TIMEOUT), A
1203   06E6             
1204   06E6 3E 00           LD  A, 0
1205   06E8 32 0C FF        LD  (BUZZER), A
1206   06EB             
1207   06EB 3E 01           LD  A, 1                 ; Monitor mode
1208   06ED 32 0F FF        LD  (SYSMODE), A
1209   06F0             
1210   06F0 3E FF           LD A, $FF
1211   06F2 32 08 FF        LD (KEY_PRESS), A
1212   06F5             
1213   06F5 ED 56           IM  1
1214   06F7 FB              EI
1215   06F8             
1216   06F8 AF              XOR A
1217   06F9 D3 40           OUT (Port40), A
1218   06FB             
1219   06FB             
1220   06FB 3E 00           LD  A, $00
1221   06FD 32 00 FF        LD  (DIG_0), A
1222   0700             
1223   0700 3E 00           LD  A, $00
1224   0702 32 01 FF        LD  (DIG_1), A
1225   0705             
1226   0705 3E 00           LD  A, $0
1227   0707 32 02 FF        LD  (DIG_2), A
1228   070A             
1229   070A 3E 00           LD  A, $00
1230   070C 32 03 FF        LD  (DIG_3), A
1231   070F             
1232   070F 3E 00           LD  A, $00
1233   0711 32 04 FF        LD  (DIG_4), A
1234   0714             
1235   0714 3E 00           LD  A, $00
1236   0716 32 05 FF        LD  (DIG_5), A
1237   0719             
1238   0719 3E 00           LD  A, $00
1239   071B 32 06 FF        LD  (DIG_6), A
1240   071E             
1241   071E 3E 00           LD  A, $00
1242   0720 32 07 FF        LD  (DIG_7), A
1243   0723             
1244   0723             START_LOOP:
1245   0723             
1246   0723 C3 23 07        JP START_LOOP
1247   0726             
1248   0726             
1249   0726             
1250   0726             
1251   0726             
1252   0726             
1253   0726             
1254   0726             
1255   0726             
1256   0726             ; =========================================================
1257   0726             ; Delay
1258   0726             ; =========================================================
1259   0726             delay:
1260   0726 C5          	push bc                       ; 2.75 us
1261   0727 06 FF           ld b, 255                     ; 1.75 us
1262   0729             delay_loop_b:
1263   0729 0E FF       	ld c, 255                     ; 1.75 us
1264   072B             delay_loop:
1265   072B 0D          	dec c                         ; 1 us
1266   072C C2 2B 07        jp nz, delay_loop             ; true = 3 us, false 1.75 us
1267   072F 05              dec b                         ; 1 us
1268   0730 C2 29 07        jp nz, delay_loop_b           ; true = 3 us, false 1.75 us
1269   0733 C1              pop bc                        ; 2.50 us
1270   0734 C9              ret                           ; 2.50 us
1271   0735             
1272   0735             
1273   0735             ;============================================================================
1274   0735             ;	Subroutine	Delay_A
1275   0735             ;
1276   0735             ;	Entry:	A = Millisecond count
1277   0735             ;============================================================================
1278   0735 E5          DELAY_A:	PUSH	HL			; Save count
1279   0736 21 10 FF    		LD	HL,TicCounter
1280   0739 86          		ADD	A,(HL)			; A = cycle count
1281   073A BE          DlyLp		CP	(HL)			; Wait required TicCounter times
1282   073B C2 3A 07    		JP	NZ,DlyLp		;  loop if not done
1283   073E E1          		POP	HL
1284   073F C9          		RET
1285   0740             
1286   0740             
1287   0740 0E 01       DELAY_100mS	LD	C,1
1288   0742 C5          DELAY_C		PUSH	BC
1289   0743 06 00       		LD	B,0
1290   0745 C5          DELAY_LP	PUSH	BC
1291   0746 10 FE       		DJNZ	$		;13   * 256 / 4 = 832uSec
1292   0748 C1          		POP	BC
1293   0749 10 FA       		DJNZ	DELAY_LP	;~100mSEC
1294   074B 0D          		DEC	C
1295   074C 20 F7       		JR  NZ,	DELAY_LP	;*4 ~= 7mSec
1296   074E C1          		POP	BC
1297   074F C9          		RET
1298   0750             
1299   0750             ; Mapa char to display 0-F
1300   0750 3F065B4F666DLED_FONT .db $3F, $06, $5B, $4F, $66, $6D, $7D, $07, $7F, $67 ; 0-9
1300   0756 7D077F67
1301   075A 777C395E7971         .DB $77, $7C, $39, $5E, $79, $71                     ; A-F
1302   0760             
1303   0760             
1304   0760             
1305   0760             ; ---------------------------------------------------------
1306   0760             ; RAM MAP - Utilitys Program | $FF30 - $FFFF
1307   0760             ; ---------------------------------------------------------
1308   0760             DIEGO      .equ    $FF30   ;(2) Temp Digits to countDown
1309   0760             
1310   0760             
1311   0760             
1312   0760             
1313   0760             
1314   1000             .org $1000
1315   1000 CD AC 05        CALL CLEAR_USER_DISPLAY
1316   1003 3E 00           LD  A, 0                 ; user mode
1317   1005 32 0F FF        LD (SYSMODE), A
1318   1008             
1319   1008 06 08           LD  B, $08
1320   100A 21 20 FF        LD  HL, USER_DISP0
1321   100D 3E 08           LD  A, 8
1322   100F             
1323   100F             LEDS_LOOP:
1324   100F CD AC 05        CALL CLEAR_USER_DISPLAY
1325   1012 70              LD  (HL), B
1326   1013 CD 40 07        CALL DELAY_100mS
1327   1016 23              INC HL
1328   1017 3D              DEC A
1329   1018 FE 00           CP 0
1330   101A C2 0F 10        JP NZ, LEDS_LOOP
1331   101D             
1332   101D 3E 08           LD A, 8
1333   101F 21 27 FF        LD  HL, USER_DISP7
1334   1022 06 40           LD  B, $40
1335   1024             
1336   1024             LEDS_LOOP2:
1337   1024 CD AC 05        CALL CLEAR_USER_DISPLAY
1338   1027 70              LD  (HL), B
1339   1028 CD 40 07        CALL DELAY_100mS
1340   102B 2B              DEC HL
1341   102C 3D              DEC A
1342   102D FE 00           CP 0
1343   102F C2 24 10        JP NZ, LEDS_LOOP2
1344   1032             
1345   1032 3E 08           LD  A, 8
1346   1034 21 20 FF        LD  HL, USER_DISP0
1347   1037 06 08           LD  B, $08
1348   1039 C3 0F 10        JP LEDS_LOOP
1349   103C             
1350   103C             
1351   103C             
1352   103C             
1353   103C             
1354   103C             
1355   103C             
1356   103C             
1357   103C             
1358   103C             
1359   4000             .org $4000
1360   4000             
1361   4000                 ; timer count down
1362   4000             
1363   4000 CD AC 05        CALL CLEAR_USER_DISPLAY
1364   4003 3E 39           LD  A, $39
1365   4005 32 20 FF        LD  (USER_DISP0), A
1366   4008             
1367   4008 3E 3F           LD  A, $3F
1368   400A 32 21 FF        LD  (USER_DISP1), A
1369   400D             
1370   400D 3E 1C           LD  A, $1C
1371   400F 32 22 FF        LD  (USER_DISP2), A
1372   4012             
1373   4012 3E 54           LD  A, $54
1374   4014 32 23 FF        LD  (USER_DISP3), A
1375   4017             
1376   4017 3E 78           LD  A, $78
1377   4019 32 24 FF        LD  (USER_DISP4), A
1378   401C             
1379   401C 3E 00           LD  A, $00
1380   401E 32 25 FF        LD  (USER_DISP5), A
1381   4021             
1382   4021             
1383   4021             
1384   4021 3E 40           LD  A, $40
1385   4023 32 26 FF        LD  (USER_DISP6), A
1386   4026             
1387   4026 3E 40           LD  A, $40
1388   4028 32 27 FF        LD  (USER_DISP7), A
1389   402B             
1390   402B 3E 00           LD  A, 0                 ; user mode
1391   402D 32 0F FF        LD (SYSMODE), A
1392   4030             
1393   4030             READ:
1394   4030 CD 17 04        CALL GET_KEY_A
1395   4033 FE FF           CP  $FF
1396   4035 CA 30 40        JP  Z, READ
1397   4038             
1398   4038 CD 49 40        CALL  MODIFY_KEY_POS_1D
1399   403B             
1400   403B             READ2
1401   403B CD 17 04        CALL GET_KEY_A
1402   403E FE FF           CP  $FF
1403   4040 CA 3B 40        JP  Z, READ2
1404   4043             
1405   4043 CD 55 40        CALL MODIFY_KEY_POS_0D
1406   4046             
1407   4046 C3 60 40        JP  LOOP
1408   4049             
1409   4049             
1410   4049             MODIFY_KEY_POS_1D:
1411   4049 21 30 FF        LD  HL, DIEGO
1412   404C 23              INC HL
1413   404D 77              LD  (HL), A
1414   404E CD C9 05        CALL GET_NUM_FROM_LOW
1415   4051 32 26 FF        LD  (USER_DISP6), A
1416   4054 C9              RET
1417   4055             
1418   4055             MODIFY_KEY_POS_0D:
1419   4055 21 30 FF        LD  HL, DIEGO
1420   4058 77              LD  (HL), A
1421   4059 CD C9 05        CALL GET_NUM_FROM_LOW
1422   405C 32 27 FF        LD  (USER_DISP7), A
1423   405F C9              RET
1424   4060             
1425   4060             LOOP:
1426   4060 2A 30 FF        LD  HL, (DIEGO)
1427   4063             
1428   4063             LOOP_DOWN:
1429   4063 7C              LD  A, H
1430   4064 CD C9 05        CALL GET_NUM_FROM_LOW
1431   4067 32 26 FF        LD  (USER_DISP6), A
1432   406A             
1433   406A 7D              LD  A, L
1434   406B CD C9 05        CALL GET_NUM_FROM_LOW
1435   406E 32 27 FF        LD  (USER_DISP7), A
1436   4071             
1437   4071 0E 07           LD C, 7    ; 10 x 100ms = 1seg
1438   4073 CD 42 07        CALL DELAY_C
1439   4076             
1440   4076 7D              LD A, L
1441   4077 FE 00           CP 0
1442   4079 CA 81 40        JP Z, DEC_H
1443   407C 3D              DEC A
1444   407D 6F              LD L, A
1445   407E C3 63 40        JP LOOP_DOWN
1446   4081             
1447   4081             DEC_H:
1448   4081 7C              LD  A, H
1449   4082 FE 00           CP 0
1450   4084 CA 8F 40        JP Z, CHECK_L
1451   4087 3D              DEC A
1452   4088 67              LD H, A
1453   4089 3E 09           LD A, 9
1454   408B 6F              LD L, A
1455   408C C3 63 40        JP LOOP_DOWN
1456   408F             
1457   408F             CHECK_L:
1458   408F 7D              LD  A, L
1459   4090 FE 00           CP 0
1460   4092 CA 95 40        JP Z, BEEP
1461   4095             
1462   4095             BEEP:
1463   4095 3A 0C FF        LD  A, (BUZZER)
1464   4098 EE 01           XOR 1
1465   409A 32 0C FF        LD  (BUZZER), A
1466   409D 0E 01           LD  C, 1
1467   409F CD 42 07        CALL DELAY_C
1468   40A2 C3 95 40        JP BEEP
1469   40A5             
1470   40A5             
1471   40A5             
1472   40A5             
1473   40A5             
1474   40A5             
1475   40A5             .end
1476   40A5             
1477   40A5             ; =========================================================
1478   40A5             ; Tabela display
1479   40A5             ; =========================================================
1480   40A5             ; 
1481   40A5             ;   0 - $3F
1482   40A5             ;   1 - $06
1483   40A5             ;   2 - $5B
1484   40A5             ;   3 - $4F
1485   40A5             ;   4 - $66
1486   40A5             ;   5 - $6D
1487   40A5             ;   6 - $7D
1488   40A5             ;   7 - $07
1489   40A5             ;   8 - $7F
1490   40A5             ;   9 - $67
1491   40A5             ; 
1492   40A5             ;   A - $77
1493   40A5             ;   B - $7C
1494   40A5             ;   C - $39
1495   40A5             ;   D - $5E
1496   40A5             ;   E - $79
1497   40A5             ;   F - $71
1498   40A5             ;   G - $6F
1499   40A5             ;   H - $76
1500   40A5             ;   I - $06
1501   40A5             ;   J - $1E
1502   40A5             ;   K - $7A
1503   40A5             ;   L - $38
1504   40A5             ;   M - $37
1505   40A5             ;   N - $54
1506   40A5             ;   O - $3F
1507   40A5             ;   P - $73
1508   40A5             ;   Q - $67
1509   40A5             ;   R - $50
1510   40A5             ;   S - $6D
1511   40A5             ;   T - $78
1512   40A5             ;   U - $1C
1513   40A5             ;   V - $3E
1514   40A5             ;   W - $1D
1515   40A5             ;   X - $70
1516   40A5             ;   Y - $6E
1517   40A5             ;   Z - $49
1518   40A5             ;
1519   40A5             ;   + - $46
1520   40A5             ;   , - $04
1521   40A5             ;   - - $40
1522   40A5             ;   . - $80
1523   40A5             ;   Ñ - $55
1524   40A5             ;   : - $41
1525   40A5             ;   ; - $88
1526   40A5             ;   _ - $08
tasm: Number of errors = 0
